<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>  Super Mario World Koopa Krisis |  David Leonard</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/pygment_trac.css">
    <link rel="stylesheet" href="/css/jquery.bxslider.css" />
    <link rel="stylesheet" href="/bootstrap/css/bootstrap-responsive.min.css">
    <link rel="stylesheet" href="/fontAwesome/css/font-awesome.min.css">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
    <script src="/js/jquery.bxslider.min.js"></script>
</head>

<body>
    <div class="wrapper">
        <header>
        <nav role="navigation">
            <ul>
                <li><a href="/about/">About</a></li>
                <li><a href="/portfolio/">Projects</a></li>
                <li><a href="/blog/">Blog</a></li>
                <li><a href="/contact/">Contact</a></li>
            </ul>
        </nav>
        </header>

        <div class="wrapper">
        <section>
        <h2 class="content">Super Mario World Koopa Krisis</h2>

          <p class="post-meta">
                13 Aug 2013
          </p>

        <img src="/img/koopa-krisis/titlescreen.png" />
        <p>Super Mario World - Koopa Krisis is a JavaScript remake of Super Mario World, built on top of the ImpactJS Game Engine, purely for educational purposes. The motivation of this project is to create a browser-only version of one of the most iconic games in the history of Nintendo, and to further my knowledge of JavaScript and the ImpactJS framework.</p>

<h4 id="motivation">Motivation</h4>

<p>As the new leader of CCNY ACM’s Game Development group for the Fall 2013 - Spring 2014 year, I decided to experiment with the ImpactJS Game Engine after being exposed to it in Fall 2012. I decided to begin working on a simple platformer game in late July, which soon turned out to be heavily based on Super Mario World. My motivation was to create a skeleton game which others could build on top of, and to produce a well polished game at the end of the Fall 2013 semester. Once our Game Development club meetings started, I assembled a team of 5 others and development began. </p>

<h4 id="development-roadmap">Development Roadmap</h4>

<p>My team this semester was very enthusiastic about this game, and so I knew that a detailed listing of all tasks needed to be done. After spending a session explaining the game engine, basic JavaScript and how projects are structured using ImpactJS, my group quickly caught on and started to work on their respective tasks. A list of comprehensive tasks are shown below:</p>

<ul>
  <li>Artificial Intelligence of Enemies
    <ul>
      <li>Understanding the ImpactJS Game loop </li>
      <li>Graphics for Enemies</li>
    </ul>
  </li>
  <li>Powerup System
    <ul>
      <li>Various powerups</li>
      <li>Powerup transitions when getting hit</li>
    </ul>
  </li>
  <li>Collectible Items
    <ul>
      <li>Coins</li>
      <li>Free lives</li>
    </ul>
  </li>
  <li>Ability to transition between levels
    <ul>
      <li>Ability to have different songs per level</li>
    </ul>
  </li>
  <li>Ability to use pipes to transition to levels</li>
  <li>Sloped tile movement</li>
  <li>Level building
    <ul>
      <li>Asset gathering</li>
    </ul>
  </li>
</ul>

<p>I decided to give each member of my team 1-2 different enemies each week to work on, while providing a skeleton file containing the animation frames already set up, as well as detailed descriptions of enemy behavior coupled with videos of demonstration for those not familiar with Super Mario World. In the meantime, I would work on various systems such as the powerups, collectible items, level building and other things critical to the gameplay itself.</p>

<h4 id="understanding-the-impactjs-game-loop">Understanding the ImpactJS Game Loop</h4>

<p>To discuss creating enemy AI, we must first understand ImpactJS’s game loop. Any object that can interact within the game’s environment is called an <code>entity</code>, and therefore creating new enemies is the same as creating a new entity. Each entity has their own base methods which can be extended. To make our codebase modular, we created a base entity named <code>basic_ai.js</code> which contains these methods, allowing us to extend from it and have our new entities inherit the properties from <code>basic_ai.js</code> and drastically make our codebase more readable. The following is a listing of the important methods found within our <code>basic_ai.js</code> module:</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span>     <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 2</span>             <span class="c1">// Init method is used for setting up animations</span>
<span class="lineno"> 3</span>             <span class="c1">// and temporary variables</span>
<span class="lineno"> 4</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>             <span class="c1">// Set up animations</span>
<span class="lineno"> 7</span>             <span class="cm">/** Animations should be handled by each enemy. **/</span>
<span class="lineno"> 8</span>             <span class="k">this</span><span class="p">.</span><span class="nx">healthTimer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Timer</span><span class="p">();</span>
<span class="lineno"> 9</span>             <span class="nx">tempHealth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">health</span><span class="p">;</span>
<span class="lineno">10</span>             <span class="c1">// Load player object if not in Weltmeister</span>
<span class="lineno">11</span>             <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">ig</span><span class="p">.</span><span class="nx">global</span><span class="p">.</span><span class="nx">wm</span><span class="p">)</span>
<span class="lineno">12</span>                 <span class="nx">my_player</span> <span class="o">=</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">getEntitiesByType</span><span class="p">(</span><span class="s1">&#39;EntityPlayer&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno">13</span>         <span class="p">}</span>        
</code></pre></div>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span>      <span class="c1">// handleMovementTrace is mostly for checking collisions</span>
<span class="lineno"> 2</span>      <span class="c1">// against other entities in conjunction with the </span>
<span class="lineno"> 3</span>      <span class="c1">// `collidesWith method.</span>
<span class="lineno"> 4</span>      <span class="nx">handleMovementTrace</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 5</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>             <span class="c1">// If the enemy collides with a wall, make them turn around.</span>
<span class="lineno"> 8</span>             <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">collision</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 9</span>                 <span class="k">this</span><span class="p">.</span><span class="nx">flip</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">10</span>                 <span class="k">this</span><span class="p">.</span><span class="nx">currentAnim</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">11</span>             <span class="p">}</span>
<span class="lineno">12</span>         <span class="p">},</span> 
<span class="lineno">13</span>     
</code></pre></div>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span>     <span class="c1">// Collisions with player are handled through the following function.</span>
<span class="lineno"> 2</span>         <span class="cm">/** Certain enemies with advanced collisions may wish to override this</span>
<span class="lineno"> 3</span> <span class="cm">            function with their own collision handling code. **/</span>
<span class="lineno"> 4</span>         <span class="nx">collideWith</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">,</span> <span class="nx">axis</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 5</span>             <span class="c1">// Only do something if colliding with the Player</span>
<span class="lineno"> 6</span>             <span class="k">if</span><span class="p">(</span><span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">EntityPlayer</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 7</span>                 <span class="c1">// Prevents enemy from being killed from below.</span>
<span class="lineno"> 8</span>                 <span class="k">if</span><span class="p">(</span><span class="nx">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 9</span>                     <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">damage_jump</span><span class="p">;</span>
<span class="lineno">10</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">kill</span><span class="p">();</span>
<span class="lineno">11</span>                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">12</span>                     <span class="nx">other</span><span class="p">.</span><span class="nx">receiveDamage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collide_damage</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="lineno">13</span>                     <span class="c1">// Push player back if collides with enemy horizontally.</span>
<span class="lineno">14</span>                     <span class="k">if</span><span class="p">(</span><span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
<span class="lineno">15</span>                         <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">damage_push</span><span class="p">;</span>
<span class="lineno">16</span>                     <span class="k">else</span>
<span class="lineno">17</span>                         <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">damage_push</span><span class="p">;</span>
<span class="lineno">18</span>                 <span class="p">}</span>
<span class="lineno">19</span>                 
<span class="lineno">20</span>                 <span class="c1">// If player&#39;s health &lt;= 0 (player dead), re-detect player</span>
<span class="lineno">21</span>                 <span class="c1">// entity (respawned player).</span>
<span class="lineno">22</span>                 <span class="k">if</span><span class="p">(</span><span class="nx">other</span><span class="p">.</span><span class="nx">health</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<span class="lineno">23</span>                     <span class="nx">my_player</span> <span class="o">=</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">getEntitiesByType</span><span class="p">(</span><span class="s1">&#39;EntityPlayer&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno">24</span>             <span class="p">}</span>
<span class="lineno">25</span>         <span class="p">},</span>
</code></pre></div>

<div class="highlight"><pre><code class="javascript"><span class="lineno">1</span>     <span class="c1">// Simply setting up collisions isn&#39;t enough, we must create a method</span>
<span class="lineno">2</span>     <span class="c1">// which will check if a collision occurs. This method overrides the</span>
<span class="lineno">3</span>     <span class="c1">// .check() function, which gets called when a collision is detected,</span>
<span class="lineno">4</span>     <span class="c1">// and applies damage to the entity it collides with.</span>
<span class="lineno">5</span>     <span class="nx">check</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">,</span> <span class="nx">axis</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">6</span>             <span class="k">if</span><span class="p">(</span><span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">EntityPlayer</span><span class="p">)</span>
<span class="lineno">7</span>                 <span class="k">if</span><span class="p">(</span><span class="nx">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="lineno">8</span>                     <span class="nx">other</span><span class="p">.</span><span class="nx">receiveDamage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collide_damage</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="lineno">9</span>         <span class="p">},</span>
</code></pre></div>

<div class="highlight"><pre><code class="javascript"><span class="lineno">1</span>     <span class="c1">// Enemy&#39;s death (and player&#39;s rewards from enemy&#39;s death) is handled</span>
<span class="lineno">2</span>     <span class="c1">// through the following function.</span>
<span class="lineno">3</span>         <span class="nx">kill</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">4</span>             <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">kills</span><span class="o">++</span><span class="p">;</span>
<span class="lineno">5</span>             <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">increaseScore</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">kill_score</span><span class="p">);</span>
<span class="lineno">6</span>             <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span><span class="nx">EntityDeathExplosionParticle</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="p">{</span><span class="nx">particles</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="nx">colorOffset</span><span class="o">:</span> <span class="mi">1</span><span class="p">});</span>
<span class="lineno">7</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span>
<span class="lineno">8</span>         <span class="p">},</span>
</code></pre></div>

<div class="highlight"><pre><code class="javascript"><span class="lineno">1</span>     <span class="c1">// Enemy receiving damage is handled through the following function.</span>
<span class="lineno">2</span>         <span class="nx">receiveDamage</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">3</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
<span class="lineno">4</span>             <span class="k">this</span><span class="p">.</span><span class="nx">healthTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">5</span>         <span class="p">}</span>
</code></pre></div>

<p>With these methods written, there only remains two methods needed to implement: <code>draw()</code> and <code>update()</code>. Both of these methods are called on every frame of the game, and the <code>update()</code> method contains the meat of manipulating an entity through various properties. Due to the behavior of the <code>update()</code> method, we create methods such as <code>init()</code> which will initialize the variables and properties needed by the entity, such as flags denoting when to attack or when to follow a player. </p>

<h4 id="enemy-artificial-intelligence">Enemy Artificial Intelligence</h4>

<p>Now that we are more familiar with ImpactJS’s game loop, we can move on to creating some new enemies. Suppose we want to create a simple entity which will walk from right to left, and if it collides with a wall, it flips and begins to walk in the opposite direction. This is simple enough, as shown in the snippet below of <code>blue_koopa.js</code>:</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span> <span class="cm">/*</span>
<span class="lineno"> 2</span> <span class="cm">    Blue Koopa</span>
<span class="lineno"> 3</span> <span class="cm">    ----------</span>
<span class="lineno"> 4</span> <span class="cm">    AI: Moves left and right, detects ledges.</span>
<span class="lineno"> 5</span> <span class="cm">*/</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;game.entities.enemies.blue_koopa&#39;</span><span class="p">)</span>
<span class="lineno"> 8</span> <span class="p">.</span><span class="nx">requires</span><span class="p">(</span><span class="s1">&#39;game.entities.ai.basic_ai&#39;</span><span class="p">)</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="p">.</span><span class="nx">defines</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">11</span>     <span class="nx">EntityBlue_koopa</span> <span class="o">=</span> <span class="nx">EntityBasic_ai</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>         <span class="c1">// Add animation</span>
<span class="lineno">14</span>         <span class="nx">animSheet</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">AnimationSheet</span><span class="p">(</span><span class="s1">&#39;media/enemies/koopa_blue.png&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
<span class="lineno">15</span>         <span class="nx">size</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">29</span><span class="p">},</span>
<span class="lineno">16</span>         <span class="c1">//flip: false,</span>
<span class="lineno">17</span>         <span class="c1">//health: 10,</span>
<span class="lineno">18</span>         <span class="nx">collide_damage</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
<span class="lineno">19</span>         <span class="nx">stomp</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Sound</span><span class="p">(</span><span class="s1">&#39;media/sounds/sfx/smw_stomp.*&#39;</span><span class="p">),</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>         <span class="c1">// Set up animations</span>
<span class="lineno">22</span>         <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">23</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>
<span class="lineno">24</span>             <span class="k">this</span><span class="p">.</span><span class="nx">addAnim</span><span class="p">(</span><span class="s1">&#39;crawl&#39;</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<span class="lineno">25</span>             <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="lineno">26</span>             <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno">27</span>         <span class="p">},</span>
<span class="lineno">28</span> 
<span class="lineno">29</span>         <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">30</span>             <span class="c1">// On collision, a flip property is toggled,</span>
<span class="lineno">31</span>             <span class="c1">// allowing movement in the opposite direction</span>
<span class="lineno">32</span>             <span class="kd">var</span> <span class="nx">xdir</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">33</span>             <span class="k">this</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">*</span> <span class="nx">xdir</span><span class="p">;</span>
<span class="lineno">34</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span>
<span class="lineno">35</span>         <span class="p">}</span>
<span class="lineno">36</span>     <span class="p">});</span> <span class="c1">// End EntityBlueKoopa</span>
<span class="lineno">37</span> <span class="p">});</span> <span class="c1">// End .defines</span>
</code></pre></div>

<p>Even though the enemy above is very simplistic, it follows the main recipe for most enemies in Super Mario World - it moves from right to left, and flips on collision. Building on top of this entity, we can create an entity which follows the player once they are in close proximity to each other. Below is a snippet containing the <code>update()</code> method of <code>flying_yellow_koopa</code>, which exhibits this behavior: </p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span>      <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 2</span>             <span class="kd">var</span> <span class="nx">xdir</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 3</span>             <span class="k">this</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">*</span> <span class="nx">xdir</span><span class="p">;</span>
<span class="lineno"> 4</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>             <span class="k">if</span><span class="p">(</span><span class="nx">my_player</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 7</span>                 <span class="kd">var</span> <span class="nx">target_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 8</span>                 <span class="kd">var</span> <span class="nx">target_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 9</span>                 <span class="nx">target_x</span> <span class="o">=</span> <span class="nx">my_player</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="lineno">10</span>                 <span class="nx">target_y</span> <span class="o">=</span> <span class="nx">my_player</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="lineno">11</span>                 <span class="kd">var</span> <span class="nx">stalking</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>                 <span class="c1">// Player is within enemy&#39;s potential detection range but has not detected player yet</span>
<span class="lineno">14</span>                 <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stalking</span> <span class="o">&amp;&amp;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">target_x</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stalk_check_dist</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">target_y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stalk_check_dist</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">15</span>                     <span class="c1">// Player in enemy&#39;s line-of-sight --&gt; Begin stalking behavior</span>
<span class="lineno">16</span>                     <span class="k">if</span><span class="p">((</span><span class="nx">target_x</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">target_x</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">))</span>
<span class="lineno">17</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">stalking</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">18</span>                 <span class="c1">// Enemy has detected player --&gt; Begin stalking behavior; </span>
<span class="lineno">19</span>                 <span class="c1">// Extend detection/stalking range</span>
<span class="lineno">20</span>                 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stalking</span> <span class="o">&amp;&amp;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">target_x</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stalk_chase_dist</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">target_y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stalk_chase_dist</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">21</span>                     <span class="c1">// Player is behind enemy --&gt; Enemy faces player</span>
<span class="lineno">22</span>                     <span class="k">if</span><span class="p">((</span><span class="nx">target_x</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">target_x</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">))</span> <span class="p">{</span>
<span class="lineno">23</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">flip</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">24</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">crawl</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">25</span>                     <span class="p">}</span>
<span class="lineno">26</span>                 <span class="c1">// Player stepped outside of detection distance --&gt; Reset behavior (do not stalk)</span>
<span class="lineno">27</span>                 <span class="p">}</span> <span class="k">else</span>
<span class="lineno">28</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">stalking</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">29</span>             <span class="p">}</span>
<span class="lineno">30</span>         <span class="p">}</span>
</code></pre></div>

<p>After creating over 20+ enemies, it became clear to my group that creating more advanced entities simply revolves around having more and more properties, with each one acting as flags denoting their behavior at different instances of time based on other conditions. In actuality, this is the power of <strong>Object Oriented Programming</strong>, which gives the advantage of building complex structures while building off objects and the properties/attributes used to describe those objects. Within just a few weeks of development, my group became familiar with the ImpactJS Game Engine and we began to move into more complicated gameplay features. </p>

<h4 id="level--music-transitions">Level / Music Transitions</h4>

<p>Moving on to more aesthetic gameplay features, we decided to tackle the problem of having different songs for each level. ImpactJS has its own <code>sound</code> class which can be derived from, unfortunately it has no way of playing different songs for different levels without a hacky solution. Fortunately, we were able to come up with a clever solution involving a plugin created for ImpactJS named <code>director</code>, which contains a set of helpful methods for creating an array of levels that can be transitioned through using provided methods. By tailoring this plugin and creating a second array containing our songs, we were able to sync up both our <code>level array</code> and <code>music array</code> and manipulate the game loop to map each song to each level. The following code snippet shows our solution:</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span>     <span class="nx">ig</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span>
<span class="lineno"> 2</span>     <span class="s1">&#39;plugins.director.director&#39;</span>
<span class="lineno"> 3</span>     <span class="p">)</span>
<span class="lineno"> 4</span>     <span class="p">.</span><span class="nx">requires</span><span class="p">(</span>
<span class="lineno"> 5</span>         <span class="s1">&#39;impact.impact&#39;</span>
<span class="lineno"> 6</span>     <span class="p">)</span>
<span class="lineno"> 7</span>     <span class="p">.</span><span class="nx">defines</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>     <span class="nx">ig</span><span class="p">.</span><span class="nx">Director</span> <span class="o">=</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Class</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
<span class="lineno">10</span>       <span class="c1">//Initialize the class with game representing the main game object</span>
<span class="lineno">11</span>       <span class="c1">//and levels being an array of level objects.</span>
<span class="lineno">12</span>       <span class="c1">//The first level in the array is loaded by default.</span>
<span class="lineno">13</span>       <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">theGame</span><span class="p">,</span> <span class="nx">initialLevels</span><span class="p">,</span> <span class="nx">initialSongs</span><span class="p">,</span> <span class="nx">musicDir</span><span class="p">){</span>
<span class="lineno">14</span>         <span class="k">this</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="nx">theGame</span><span class="p">;</span>
<span class="lineno">15</span>         <span class="k">this</span><span class="p">.</span><span class="nx">levels</span> <span class="o">=</span> <span class="p">[];</span>
<span class="lineno">16</span>         <span class="k">this</span><span class="p">.</span><span class="nx">currentLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">17</span>         <span class="k">this</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">initialLevels</span><span class="p">);</span>
<span class="lineno">18</span>         
<span class="lineno">19</span>         <span class="nx">musicDir</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">musicDir</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">musicDir</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="lineno">20</span>         <span class="nx">initialSongs</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">initialSongs</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">initialSongs</span> <span class="o">:</span> <span class="p">[];</span>
<span class="lineno">21</span>         
<span class="lineno">22</span>         <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">initialSongs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
<span class="lineno">23</span>             <span class="nx">ig</span><span class="p">.</span><span class="nx">music</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">musicDir</span> <span class="o">+</span> <span class="nx">initialSongs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
<span class="lineno">24</span>         <span class="p">}</span>
<span class="lineno">25</span>         <span class="nx">ig</span><span class="p">.</span><span class="nx">music</span><span class="p">.</span><span class="nx">loop</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">26</span>         <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadLevel</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentLevel</span><span class="p">);</span>
<span class="lineno">27</span>       <span class="p">},</span>
<span class="lineno">28</span> 
<span class="lineno">29</span>       <span class="nx">loadLevel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">levelNumber</span><span class="p">){</span>
<span class="lineno">30</span>         <span class="c1">//Load a level by its position in this.levels array</span>
<span class="lineno">31</span>         <span class="c1">//and set the this.currentLevel to that position.</span>
<span class="lineno">32</span>         <span class="k">this</span><span class="p">.</span><span class="nx">currentLevel</span> <span class="o">=</span> <span class="nx">levelNumber</span><span class="p">;</span>
<span class="lineno">33</span> 
<span class="lineno">34</span>         <span class="k">this</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">loadLevel</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">levels</span><span class="p">[</span><span class="nx">levelNumber</span><span class="p">]</span> <span class="p">);</span>
<span class="lineno">35</span>         <span class="nx">ig</span><span class="p">.</span><span class="nx">music</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span> <span class="nx">levelNumber</span> <span class="p">);</span>
<span class="lineno">36</span>         <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">37</span>       <span class="p">},</span>
<span class="lineno">38</span>       
<span class="lineno">39</span>       <span class="nx">append</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">levels</span><span class="p">){</span>
<span class="lineno">40</span>         <span class="c1">//Append a single new level or an array of new levels.</span>
<span class="lineno">41</span>         <span class="nx">newLevels</span> <span class="o">=</span> <span class="p">[];</span>
<span class="lineno">42</span>         <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">levels</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">){</span>
<span class="lineno">43</span>           <span class="k">if</span> <span class="p">(</span><span class="nx">levels</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">===</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Array</span><span class="p">).</span><span class="nx">constructor</span><span class="p">){</span>
<span class="lineno">44</span>             <span class="nx">newLevels</span> <span class="o">=</span> <span class="nx">levels</span><span class="p">;</span>
<span class="lineno">45</span>           <span class="p">}</span>
<span class="lineno">46</span>           <span class="k">else</span><span class="p">{</span>
<span class="lineno">47</span>             <span class="nx">newLevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">levels</span><span class="p">;</span>
<span class="lineno">48</span>           <span class="p">}</span>
<span class="lineno">49</span>           <span class="k">this</span><span class="p">.</span><span class="nx">levels</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">levels</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">newLevels</span><span class="p">);</span>
<span class="lineno">50</span>           <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">51</span>         <span class="p">}</span>
<span class="lineno">52</span>         <span class="k">else</span><span class="p">{</span>
<span class="lineno">53</span>           <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">54</span>         <span class="p">}</span>
<span class="lineno">55</span>       <span class="p">},</span>
<span class="lineno">56</span> 
<span class="lineno">57</span>       <span class="nx">nextLevel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
<span class="lineno">58</span>         <span class="c1">//Advance to the next level provided we are not at </span>
<span class="lineno">59</span>         <span class="c1">//the end of the array.</span>
<span class="lineno">60</span>         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentLevel</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">levels</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
<span class="lineno">61</span>           <span class="nx">ig</span><span class="p">.</span><span class="nx">music</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="lineno">62</span>           <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadLevel</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentLevel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="lineno">63</span>         <span class="p">}</span>
<span class="lineno">64</span>         <span class="k">else</span><span class="p">{</span>
<span class="lineno">65</span>           <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">66</span>         <span class="p">}</span>
<span class="lineno">67</span>       <span class="p">},</span>
</code></pre></div>

<p>And here is the change needed within <code>main.js</code>:</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno">1</span>     <span class="c1">//LevelIndex:   [0------------, 1------------------, 2---------, 3-------------------, 4---------------------, 5--------------, 6-----------------, 7---------------, 8----------, 9-------------, 10----------------, 11------------, 12-----------, 13------------, 14----------------]</span>
<span class="lineno">2</span>     <span class="nx">levelVariables</span><span class="o">:</span> <span class="p">[</span><span class="nx">LevelTutorial</span><span class="p">,</span> <span class="nx">LevelBest_overworld</span><span class="p">,</span> <span class="nx">LevelSnowy</span><span class="p">,</span> <span class="nx">LevelUndergroundsnow</span><span class="p">,</span> <span class="nx">LevelUndergrounddesert</span><span class="p">,</span> <span class="nx">LevelMainlevel1</span><span class="p">,</span> <span class="nx">LevelOutdoorcastle</span><span class="p">,</span> <span class="nx">LevelForestRuins</span><span class="p">,</span> <span class="nx">LevelDesert</span><span class="p">,</span>  <span class="nx">LevelMountain</span><span class="p">,</span> <span class="nx">LevelMaincastle</span><span class="p">,</span>    <span class="nx">LevelBoss1lair</span><span class="p">,</span> <span class="nx">LevelGauntlet</span><span class="p">,</span> <span class="nx">LevelGauntlet2</span><span class="p">,</span> <span class="nx">LevelFinalgauntlet</span><span class="p">],</span>
<span class="lineno">3</span>     <span class="nx">levelMusic</span><span class="o">:</span>     <span class="p">[</span><span class="s1">&#39;smw_remix&#39;</span><span class="p">,</span>   <span class="s1">&#39;map_theme&#39;</span><span class="p">,</span>         <span class="s1">&#39;snowman&#39;</span><span class="p">,</span>  <span class="s1">&#39;barrel_volcano&#39;</span><span class="p">,</span>     <span class="s1">&#39;ryu&#39;</span><span class="p">,</span>                  <span class="s1">&#39;maze&#39;</span><span class="p">,</span>          <span class="s1">&#39;snake_man&#39;</span><span class="p">,</span>        <span class="s1">&#39;tarm_ruins&#39;</span><span class="p">,</span>     <span class="s1">&#39;desert&#39;</span><span class="p">,</span>     <span class="s1">&#39;dark_world&#39;</span><span class="p">,</span>  <span class="s1">&#39;madness_fortress&#39;</span><span class="p">,</span> <span class="s1">&#39;epic_boss&#39;</span><span class="p">,</span>    <span class="s1">&#39;wily_castle&#39;</span><span class="p">,</span> <span class="s1">&#39;wily_castle&#39;</span><span class="p">,</span>  <span class="s1">&#39;bowser_battle&#39;</span><span class="p">],</span>
</code></pre></div>

<p>After understanding how <code>director.js</code> works in conjunction with the ImpactJS game loop, we moved onto something new: transitioning between different levels / different parts within the same level using warp pipes/doors.</p>

<h4 id="transitioning-to-different-parts-within-a-level">Transitioning to Different Parts within a Level</h4>

<p>Based on the properties of <code>director.js</code>, we realized that we can extend director and apply it to creating a <code>pipe</code> entity, which can take an arbitrary <code>key:value</code> pair representing the position/level to warp the <code>player.js</code> entity to. The following is the <code>check()</code> method for the <code>pipe.js</code> entity:</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span>     <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">();},</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>         <span class="c1">// Handle player transitions to different levels</span>
<span class="lineno"> 4</span>         <span class="nx">check</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 5</span>             <span class="c1">// Entity is on pipe but not using it</span>
<span class="lineno"> 6</span>             <span class="k">if</span><span class="p">(</span><span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">other</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">usingPipe</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 7</span>                 <span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">other</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="lineno"> 8</span>                 <span class="c1">// Entity is player; handles player animations (If entity is not player ignore entity)</span>
<span class="lineno"> 9</span>                 <span class="k">if</span><span class="p">(</span><span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">EntityPlayer</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">10</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">onPipe</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">11</span>                     <span class="c1">// Handle player&#39;s movements while on pipe</span>
<span class="lineno">12</span>                     <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">))</span> <span class="p">{</span>
<span class="lineno">13</span>                         <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">activePower</span> <span class="o">==</span> <span class="s2">&quot;EntityHammer&quot;</span><span class="p">)</span>
<span class="lineno">14</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">hammer_run</span><span class="p">;</span>
<span class="lineno">15</span>                         <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">activePower</span> <span class="o">==</span> <span class="s2">&quot;EntityFireball&quot;</span><span class="p">)</span>
<span class="lineno">16</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">fire_run</span><span class="p">;</span>
<span class="lineno">17</span>                         <span class="k">else</span>
<span class="lineno">18</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">run</span><span class="p">;</span>
<span class="lineno">19</span>                     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s1">&#39;jump&#39;</span><span class="p">))</span> <span class="p">{</span>
<span class="lineno">20</span>                         <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="o">-</span><span class="nx">other</span><span class="p">.</span><span class="nx">jump</span><span class="p">;</span>
<span class="lineno">21</span>                         <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">activePower</span> <span class="o">==</span> <span class="s2">&quot;EntityHammer&quot;</span><span class="p">)</span>
<span class="lineno">22</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">hammer_jump</span><span class="p">;</span>
<span class="lineno">23</span>                         <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">activePower</span> <span class="o">==</span> <span class="s2">&quot;EntityFireball&quot;</span><span class="p">)</span>
<span class="lineno">24</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">fire_jump</span><span class="p">;</span>
<span class="lineno">25</span>                         <span class="k">else</span>
<span class="lineno">26</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">jump</span><span class="p">;</span>
<span class="lineno">27</span>                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">28</span>                         <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">activePower</span> <span class="o">==</span> <span class="s2">&quot;EntityHammer&quot;</span><span class="p">)</span>
<span class="lineno">29</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">hammer_idle</span><span class="p">;</span>
<span class="lineno">30</span>                         <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">activePower</span> <span class="o">==</span> <span class="s2">&quot;EntityFireball&quot;</span><span class="p">)</span>
<span class="lineno">31</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">fire_idle</span><span class="p">;</span>
<span class="lineno">32</span>                         <span class="k">else</span>
<span class="lineno">33</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">idle</span><span class="p">;</span>
<span class="lineno">34</span>                     <span class="p">}</span>
<span class="lineno">35</span> 
<span class="lineno">36</span>                     <span class="c1">// Player uses pipe and is standing within acceptable boundaries of pipe</span>
<span class="lineno">37</span>                     <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s1">&#39;continue&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">onPipe</span> <span class="o">&amp;&amp;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">other</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">38</span>                         <span class="c1">// Reposition player to center of pipe</span>
<span class="lineno">39</span>                         <span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="nx">other</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="lineno">40</span>                         <span class="c1">// Start pipe usage</span>
<span class="lineno">41</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">usingPipe</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">42</span>                     <span class="p">}</span>
<span class="lineno">43</span>                 <span class="p">}</span>
<span class="lineno">44</span>             <span class="c1">// Entiy not on pipe</span>
<span class="lineno">45</span>             <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">usingPipe</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">46</span>                 <span class="c1">// Entity is player; handle player-specific repositioning (&quot;fake collision&quot;)</span>
<span class="lineno">47</span>                 <span class="k">if</span><span class="p">(</span><span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">EntityGameplayer</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">48</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">onPipe</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">49</span>                     <span class="k">if</span><span class="p">(</span><span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
<span class="lineno">50</span>                         <span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">other</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="lineno">51</span>                     <span class="k">else</span>
<span class="lineno">52</span>                         <span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="lineno">53</span>                 <span class="c1">// Entity is not player; handle other entity&#39;s repositioning</span>
<span class="lineno">54</span>                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">55</span>                     <span class="nx">other</span><span class="p">.</span><span class="nx">flip</span> <span class="o">=</span> <span class="o">!</span><span class="nx">other</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">56</span>                     <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">57</span>                 <span class="p">}</span>
<span class="lineno">58</span>             <span class="c1">// Player is using pipe</span>
<span class="lineno">59</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">60</span>                 <span class="c1">// Play some player &quot;using pipe&quot; animation and begin to descend player down pipe</span>
<span class="lineno">61</span>                 <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">activePower</span> <span class="o">==</span> <span class="s2">&quot;EntityHammer&quot;</span><span class="p">)</span>
<span class="lineno">62</span>                     <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">hammer_idle</span><span class="p">;</span>
<span class="lineno">63</span>                 <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">activePower</span> <span class="o">==</span> <span class="s2">&quot;EntityFireball&quot;</span><span class="p">)</span>
<span class="lineno">64</span>                     <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">fire_idle</span><span class="p">;</span>
<span class="lineno">65</span>                 <span class="k">else</span>
<span class="lineno">66</span>                     <span class="nx">other</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">idle</span><span class="p">;</span>
<span class="lineno">67</span>                 <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pipeSpeed</span><span class="p">;</span>
<span class="lineno">68</span>                 <span class="c1">// If player is using pipe, make sure player STAYS IN THE PIPE!</span>
<span class="lineno">69</span>                 <span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="nx">other</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="lineno">70</span>                 <span class="c1">// Player is completely inside pipe</span>
<span class="lineno">71</span>                 <span class="k">if</span><span class="p">(</span><span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">72</span>                     <span class="c1">// Handle level transitioning</span>
<span class="lineno">73</span>                     <span class="c1">// Level property has been set in Weltmeister</span>
<span class="lineno">74</span>                     <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">level</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">level</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">75</span>                         <span class="c1">// Transition to specified level</span>
<span class="lineno">76</span>                         <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">myDirector</span><span class="p">.</span><span class="nx">loadLevel</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">level</span><span class="p">);</span>
<span class="lineno">77</span>                     <span class="c1">// Level property has NOT been set in Weltmeister</span>
<span class="lineno">78</span>                     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">level</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">79</span>                         <span class="c1">// Transition to next level</span>
<span class="lineno">80</span>                         <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">myDirector</span><span class="p">.</span><span class="nx">nextLevel</span><span class="p">();</span>
<span class="lineno">81</span>                     <span class="p">}</span>
<span class="lineno">82</span> 
<span class="lineno">83</span>                     <span class="c1">// Spawn position has been set in Weltmeister</span>
<span class="lineno">84</span>                     <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spawn</span><span class="p">.</span><span class="nx">x</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">spawn</span><span class="p">.</span><span class="nx">y</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">85</span>                         <span class="c1">// Move player to specified (x, y) position of new level</span>
<span class="lineno">86</span>                         <span class="nx">my_player</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spawn</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="lineno">87</span>                         <span class="nx">my_player</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spawn</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="lineno">88</span>                     <span class="p">}</span>
<span class="lineno">89</span>                 <span class="p">}</span>
<span class="lineno">90</span>             <span class="p">}</span>
</code></pre></div>

<p>With this, we were able to use pipes to transition to bonus levels or to go to different portions within a level (as well as return), just like the original Super Mario World!</p>

<h4 id="overworld">Overworld</h4>

<p>As one last aesthetic feature, we decided to tackle creating an overworld. The first task was to figure out how to transition between different game states within ImpactJS, while still having a reference to levels and the player entity without making these global variables. Due to having a top-down perspective for the overworld (as opposed to side-scrolling in the main game), a different player entity was necessary to be used on the overworld (along with its own set of physics and properties). This proved to be a major task due to confusion of how <code>director.js</code> worked in tandem with ImpactJS’s <code>loadLevel()</code> method. After roughly 45 days of working on a solution, we tailored <code>director.js</code> further (the changes were included in the listing provided earlier) and made the following changes to <code>main.js</code>:</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span>     <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 2</span>         <span class="cm">/* This code allows the camera to follow the player</span>
<span class="lineno"> 3</span> <span class="cm">           by overriding the update function using the method</span>
<span class="lineno"> 4</span> <span class="cm">           of the game class called `getEntitiesByType()`.</span>
<span class="lineno"> 5</span> <span class="cm">           This API allows us to find instances of entities in</span>
<span class="lineno"> 6</span> <span class="cm">           our game. */</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>         <span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getEntitiesByType</span><span class="p">(</span> <span class="nx">EntityPlayer</span> <span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno"> 9</span>         <span class="k">if</span><span class="p">(</span> <span class="nx">player</span> <span class="p">)</span> <span class="p">{</span>
<span class="lineno">10</span>             <span class="k">this</span><span class="p">.</span><span class="nx">camera</span><span class="p">.</span><span class="nx">follow</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">);</span>
<span class="lineno">11</span>             <span class="c1">//this.screen.x = player.pos.x - ig.system.width/2;</span>
<span class="lineno">12</span>             <span class="c1">//this.screen.y = player.pos.y - ig.system.height/2;</span>
<span class="lineno">13</span>             <span class="c1">// If the player moves, erase the instructions</span>
<span class="lineno">14</span>             <span class="k">if</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">accel</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">font</span><span class="p">)</span>
<span class="lineno">15</span>                 <span class="k">this</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="lineno">16</span>         <span class="p">}</span>
<span class="lineno">17</span>         <span class="c1">// Update all entities and backgroundMaps</span>
<span class="lineno">18</span>         <span class="cm">/* We need to change this code to pull up the stat screen.</span>
<span class="lineno">19</span> <span class="cm">           We test if it is time to show the stats screen. If it</span>
<span class="lineno">20</span> <span class="cm">           is not being displayed, we call &quot;this.parent()&quot; and the</span>
<span class="lineno">21</span> <span class="cm">           game continues normally. Otherwise, we listen for an input</span>
<span class="lineno">22</span> <span class="cm">           state &#39;continue&#39; */</span>
<span class="lineno">23</span>         <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">showStats</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">showEnding</span><span class="p">){</span>
<span class="lineno">24</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span>
<span class="lineno">25</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">26</span>             <span class="k">if</span><span class="p">(</span><span class="nx">ig</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">pressed</span><span class="p">(</span><span class="s1">&#39;continue&#39;</span><span class="p">))</span> <span class="p">{</span>
<span class="lineno">27</span>                 <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span>
<span class="lineno">28</span>                 <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">myDirector</span><span class="p">.</span><span class="nx">currentLevel</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">finalStage</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">finalStageEnabled</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">29</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">showEnding</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">30</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">showStats</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">31</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">maxStage</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">myDirector</span><span class="p">.</span><span class="nx">currentLevel</span><span class="p">;</span>
<span class="lineno">32</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">myDirector</span><span class="p">.</span><span class="nx">loadLevel</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">33</span>                     <span class="nx">ig</span><span class="p">.</span><span class="nx">music</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">34</span>                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">35</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">showEnding</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">36</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">showStats</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">37</span>                     <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lives</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">bonusReqLives</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">finalStageEnabled</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">38</span>                         <span class="nx">ig</span><span class="p">.</span><span class="nx">system</span><span class="p">.</span><span class="nx">setGame</span><span class="p">(</span><span class="nx">StartScreen</span><span class="p">);</span>
<span class="lineno">39</span>                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">40</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">finalStageEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">41</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">maxStage</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">myDirector</span><span class="p">.</span><span class="nx">currentLevel</span><span class="p">;</span>
<span class="lineno">42</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">myDirector</span><span class="p">.</span><span class="nx">loadLevel</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">43</span>                         <span class="nx">ig</span><span class="p">.</span><span class="nx">music</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">44</span>                     <span class="p">}</span>
<span class="lineno">45</span>                 <span class="p">}</span>
<span class="lineno">46</span>             <span class="p">}</span>
<span class="lineno">47</span>         <span class="p">}</span>
</code></pre></div>

<p>After having the ability to transition between different game states while swapping out different entities based on the level, a beautiful custom overworld was built from scratch:</p>

<p><img src="/img/koopa-krisis/overworld.png" alt="Koopa Krisis Overworld" /></p>

<h4 id="final-boss">Final Boss</h4>

<p>Wrapping up our development time before releasing our game, we knew we needed a final boss that was both challenging yet beatable. After brainstorming and planning out the behavior of our boss, it was time to undertake the creation of <code>iggy_koopa.js</code>. The behavior is outlined below:</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno">  1</span> <span class="cm">/*</span>
<span class="lineno">  2</span> <span class="cm">Iggy Koopa</span>
<span class="lineno">  3</span> <span class="cm">----------</span>
<span class="lineno">  4</span> <span class="cm">A boss featuring the combination of AIs from currently existing enemies (at the</span>
<span class="lineno">  5</span> <span class="cm">time of implementation):</span>
<span class="lineno">  6</span> <span class="cm">  1. [Modified] Stalker AI from Flying Yellow Koopa.</span>
<span class="lineno">  7</span> <span class="cm">  2. [Modified] Protection/Spiky state from Bony Beetle (new).</span>
<span class="lineno">  8</span> <span class="cm">  3. Linear multi-attack projectiles from Bullet Shooter.</span>
<span class="lineno">  9</span> <span class="cm">  4. [Modified] Independent multi-attack projectiles from Hammer Bros.</span>
<span class="lineno"> 10</span> <span class="cm">  5. Skipping (jumping while moving) AI from Flying Green Koopa.</span>
<span class="lineno"> 11</span> <span class="cm">  5. [Modified] Randomized jumping from Jumping Ninji.</span>
<span class="lineno"> 12</span> 
<span class="lineno"> 13</span> <span class="cm">Custom/Derived AIs:</span>
<span class="lineno"> 14</span> <span class="cm">  1. Derived from stalker --&gt; Waits until provoked by player or if player is near.</span>
<span class="lineno"> 15</span> <span class="cm">  2. Derived from protection/spiky state --&gt; Random protection/spiky state duration.</span>
<span class="lineno"> 16</span> <span class="cm">  3. Derived from protection/spiky state --&gt; Panick state.</span>
<span class="lineno"> 17</span> <span class="cm">  4. Derived from randomized jumping --&gt; Random jump frequency with random jump height.</span>
<span class="lineno"> 18</span> <span class="cm">  5. Derived from linear attack projectiles --&gt; linear attack projectiles with random spread.</span>
<span class="lineno"> 19</span> <span class="cm">  6. Multiple health-based AI stages.</span>
<span class="lineno"> 20</span> <span class="cm">  7. Anti-&quot;I cannot reach player&quot; AI.</span>
<span class="lineno"> 21</span> <span class="cm">  8. Anti-&quot;hammer/fireball damage abuse&quot; AI.</span>
<span class="lineno"> 22</span> <span class="cm">  9. Anti-&quot;enemy abuse player&quot; and anti-&quot;player abuse enemy&quot; grace period.</span>
<span class="lineno"> 23</span> <span class="cm">  10. Auto-complete level on death.</span>
<span class="lineno"> 24</span> 
<span class="lineno"> 25</span> 
<span class="lineno"> 26</span> <span class="cm">----- Initial/Basic AI -----</span>
<span class="lineno"> 27</span> <span class="cm">1. Enemy will initially remain stationary until player comes within detection</span>
<span class="lineno"> 28</span> <span class="cm">   range or enemy is provoked (such as if player attacks from afar).</span>
<span class="lineno"> 29</span> <span class="cm">2. If enemy has lost track of player, enemy defaults to basic left/right</span>
<span class="lineno"> 30</span> <span class="cm">   movement. Enemy will move in the opposite direction if it collides with an</span>
<span class="lineno"> 31</span> <span class="cm">   obstacle.</span>
<span class="lineno"> 32</span> 
<span class="lineno"> 33</span> <span class="cm">----- Detection/Chase AI -----</span>
<span class="lineno"> 34</span> <span class="cm">3. If player is near enemy but NOT in enemy&#39;s line-of-sight (LoS), enemy</span>
<span class="lineno"> 35</span> <span class="cm">   ignores player and uses default AI. Enemy&#39;s LoS is a rectangular</span>
<span class="lineno"> 36</span> <span class="cm">   field-of-view directly in front of itself.</span>
<span class="lineno"> 37</span> <span class="cm">4. If enemy detected player (either by distance or by provoke), enemy begins</span>
<span class="lineno"> 38</span> <span class="cm">   chasing player and extends its detection range.</span>
<span class="lineno"> 39</span> <span class="cm">   a. If enemy is following player and player moves behind enemy, enemy faces</span>
<span class="lineno"> 40</span> <span class="cm">      player and continues to chasing.</span>
<span class="lineno"> 41</span> <span class="cm">   b. If enemy is following player and player steps out of enemy&#39;s detection</span>
<span class="lineno"> 42</span> <span class="cm">      range, enemy stops following player and resets to default AI.</span>
<span class="lineno"> 43</span> <span class="cm">5. If enemy detected player and player is above enemy for too long (enemy cannot</span>
<span class="lineno"> 44</span> <span class="cm">   reach player), enemy will increase its average jump height (still random) in</span>
<span class="lineno"> 45</span> <span class="cm">   an attempt to overcome obstacle.</span>
<span class="lineno"> 46</span> <span class="cm">6. Extending from #5: If enemy still cannot reach player and enemy is not in</span>
<span class="lineno"> 47</span> <span class="cm">   angry or rampage state, give up and patrol (walk left and right) around the</span>
<span class="lineno"> 48</span> <span class="cm">   immediate area. If it cannot reach player while in angry or rampage state,</span>
<span class="lineno"> 49</span> <span class="cm">   continue to chase player indefinitely. If enemy redetects player after giving</span>
<span class="lineno"> 50</span> <span class="cm">   up, restart chasing AI.</span>
<span class="lineno"> 51</span> <span class="cm">7. If player is killed, stop detection and chasing to give player time to</span>
<span class="lineno"> 52</span> <span class="cm">   rethink strategy (for a short time). If enemy redetects player afterwards,</span>
<span class="lineno"> 53</span> <span class="cm">   restart chasing AI.</span>
<span class="lineno"> 54</span> 
<span class="lineno"> 55</span> <span class="cm">----- Randomized Jumping while Moving AI -----</span>
<span class="lineno"> 56</span> <span class="cm">8. Enemy will jump while moving.</span>
<span class="lineno"> 57</span> <span class="cm">9. Enemy will jump random heights at random intervals.</span>
<span class="lineno"> 58</span> <span class="cm">   a. Enemy may jump when firing its attack causing attack projectiles to be</span>
<span class="lineno"> 59</span> <span class="cm">      launched at jump height.</span>
<span class="lineno"> 60</span> <span class="cm">   b. See #5.</span>
<span class="lineno"> 61</span> 
<span class="lineno"> 62</span> <span class="cm">----- Protection/Shell State AI -----</span>
<span class="lineno"> 63</span> <span class="cm">10. If the player jumps on enemy when enemy is NOT in shell state, enemy will</span>
<span class="lineno"> 64</span> <span class="cm">    take damage and enter shell state (a spinning shell).</span>
<span class="lineno"> 65</span> <span class="cm">    a. In shell state, if the player jumps on enemy, player takes extra damage.</span>
<span class="lineno"> 66</span> <span class="cm">    b. Enemy will unhide (exit shell state) and revert back to default AI after</span>
<span class="lineno"> 67</span> <span class="cm">       some time has passed regardless if player is near enemy or not.</span>
<span class="lineno"> 68</span> <span class="cm">    c. Enemy duration in shell state is determined by its current AI state. The</span>
<span class="lineno"> 69</span> <span class="cm">       higher the AI state (the lower the enemy&#39;s health is), the longer the</span>
<span class="lineno"> 70</span> <span class="cm">       duration.</span>
<span class="lineno"> 71</span> <span class="cm">    d. Panick state: If enemy is in panick state and enemy enters shell state,</span>
<span class="lineno"> 72</span> <span class="cm">       enemy remains in shell state indefinately until player moves far enough</span>
<span class="lineno"> 73</span> <span class="cm">       away from enemy. While in panick state, if player is still within range,</span>
<span class="lineno"> 74</span> <span class="cm">       enemy will begin to fire projectiles randomly while in shell state. As the</span>
<span class="lineno"> 75</span> <span class="cm">       enemy&#39;s health decreases, the frequency of firing random projectiles</span>
<span class="lineno"> 76</span> <span class="cm">       increases. If player is killed while enemy is in panick shell state, enemy</span>
<span class="lineno"> 77</span> <span class="cm">       will exit shell state.</span>
<span class="lineno"> 78</span> 
<span class="lineno"> 79</span> <span class="cm">----- Multiple Health-based AI -----</span>
<span class="lineno"> 80</span> <span class="cm">11. Enemy has 3 sets of attack AIs: default, annoyed, and angry AI states.</span>
<span class="lineno"> 81</span> <span class="cm">    a. Default state: Enemy is notably faster than the average enemy. Enemy</span>
<span class="lineno"> 82</span> <span class="cm">       fires a single attack projectile in front of itself at random time</span>
<span class="lineno"> 83</span> <span class="cm">       intervals.</span>
<span class="lineno"> 84</span> <span class="cm">    b. Annoyed state: Enemy is slightly faster than default state, and shell time</span>
<span class="lineno"> 85</span> <span class="cm">       increases. Enemy fires three attack projectiles at same time in front of</span>
<span class="lineno"> 86</span> <span class="cm">       itself in a triangular formation. Center projectile is same as default</span>
<span class="lineno"> 87</span> <span class="cm">       state&#39;s projectile. Top and bottom projectiles have randomized spread</span>
<span class="lineno"> 88</span> <span class="cm">       angle with a linear trajectory.</span>
<span class="lineno"> 89</span> <span class="cm">    c. Angry state: Enemy is moderately faster than default state, and shell time</span>
<span class="lineno"> 90</span> <span class="cm">       further increases. Enemy fires 8 attack projectiles around itself in a</span>
<span class="lineno"> 91</span> <span class="cm">       circular formation. Each of the projectiles are fired at a difference of</span>
<span class="lineno"> 92</span> <span class="cm">       45-degree angle in a linear trajectory.</span>
<span class="lineno"> 93</span> <span class="cm">    d. Rampage state: Enemy is much faster than default state, attack frequency</span>
<span class="lineno"> 94</span> <span class="cm">       increases, and attack projectile speed increases. Enemy shoots a single</span>
<span class="lineno"> 95</span> <span class="cm">       projectile directed towards player&#39;s position at firing time. Enemy&#39;s</span>
<span class="lineno"> 96</span> <span class="cm">       movement and attack projectile speed linearly increases as its health</span>
<span class="lineno"> 97</span> <span class="cm">       continues to decrease.</span>
<span class="lineno"> 98</span> 
<span class="lineno"> 99</span> <span class="cm">----- Anti-camping AI -----</span>
<span class="lineno">100</span> <span class="cm">12. Enemy has anti-camping AIs. (camping = tactic where player obtains static</span>
<span class="lineno">101</span> <span class="cm">    strategic position of advantage)</span>
<span class="lineno">102</span> <span class="cm">    a. If player is on unreachable for long enough, enemy will fire a single attack</span>
<span class="lineno">103</span> <span class="cm">       projectile upwards/downwards towards player in hopes of threatening player</span>
<span class="lineno">104</span> <span class="cm">       above/below.</span>
<span class="lineno">105</span> <span class="cm">    b. Enemy will not jump up if directly below player to prevent auto-taking</span>
<span class="lineno">106</span> <span class="cm">       damage and auto-entering shell state (due to #7).</span>
<span class="lineno">107</span> <span class="cm">    c. See #5.</span>
<span class="lineno">108</span> 
<span class="lineno">109</span> <span class="cm">----- Obstacle Traversal AI -----</span>
<span class="lineno">110</span> <span class="cm">13. Enemy will attempt to climb/jump over short obstacles or walls if it is</span>
<span class="lineno">111</span> <span class="cm">    chasing player and bumps into obstruction.</span>
<span class="lineno">112</span> <span class="cm">14. See #5.</span>
<span class="lineno">113</span> 
<span class="lineno">114</span> <span class="cm">----- Abuse protection -----</span>
<span class="lineno">115</span> <span class="cm">15. Enemy cannot be abused from non-player damage projectiles as much.</span>
<span class="lineno">116</span> <span class="cm">    a. Damage from non-player projectiles that hits enemy is nerfed to 1 damage.</span>
<span class="lineno">117</span> <span class="cm">16. Enemy enters grace period under which during that time, enemy will not chase</span>
<span class="lineno">118</span> <span class="cm">    player, will not shoot projectiles, and collision damage to player is</span>
<span class="lineno">119</span> <span class="cm">    negated.</span>
<span class="lineno">120</span> <span class="cm">    a. Player cannot (or should not) abuse this grace period as player&#39;s damage</span>
<span class="lineno">121</span> <span class="cm">       to the enemy during this time will also be negated</span>
<span class="lineno">122</span> <span class="cm">17. If player is killed while enemy is in panick shell state, enemy will exit</span>
<span class="lineno">123</span> <span class="cm">    shell state. This is to prevent enemy from spamming attack projectiles near</span>
<span class="lineno">124</span> <span class="cm">    respawn zone and not giving player a chance to escape.</span>
<span class="lineno">125</span> <span class="cm">18. See #9b.</span>
<span class="lineno">126</span> 
<span class="lineno">127</span> <span class="cm">----- Game/Level controllers -----</span>
<span class="lineno">128</span> <span class="cm">19. Defeating enemy will automatically end level.</span>
<span class="lineno">129</span> <span class="cm">    a. This feature can be disabled in the enemy&#39;s properties.</span>
<span class="lineno">130</span> 
<span class="lineno">131</span> <span class="cm">*/</span>
</code></pre></div>

<p>And the actual implementation of this beast is shown below: </p>

<div class="highlight"><pre><code class="javascript"><span class="lineno">  1</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;game.entities.enemies.iggy_koopa&#39;</span><span class="p">)</span>
<span class="lineno">  2</span> <span class="p">.</span><span class="nx">requires</span><span class="p">(</span><span class="s1">&#39;game.entities.ai.basic_ai&#39;</span><span class="p">)</span>
<span class="lineno">  3</span> 
<span class="lineno">  4</span> <span class="p">.</span><span class="nx">defines</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">  5</span>     <span class="nx">EntityIggy_koopa</span> <span class="o">=</span> <span class="nx">EntityBasic_ai</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
<span class="lineno">  6</span>         <span class="c1">// Add animation and set collision</span>
<span class="lineno">  7</span>         <span class="nx">animSheet</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">AnimationSheet</span><span class="p">(</span><span class="s1">&#39;media/enemies/iggy_koopa_full.png&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
<span class="lineno">  8</span>         <span class="nx">size</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">28</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">29</span><span class="p">},</span>
<span class="lineno">  9</span>         <span class="nx">offset</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">3</span><span class="p">},</span>
<span class="lineno"> 10</span>         <span class="nx">flip</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// Enemy faces left</span>
<span class="lineno"> 11</span> 
<span class="lineno"> 12</span>         <span class="c1">// Override Basic AI default properties</span>
<span class="lineno"> 13</span>         <span class="nx">health</span><span class="o">:</span> <span class="mi">45</span><span class="p">,</span> <span class="c1">// Enemy health when spawned; Default: 55</span>
<span class="lineno"> 14</span>                     <span class="c1">// NOTE: Don&#39;t set health too low since it may skip certain AI stages;</span>
<span class="lineno"> 15</span>                     <span class="c1">//       Don&#39;t set health too high since it will be VERY hard to kill near the end (don&#39;t say I didn&#39;t warn you)</span>
<span class="lineno"> 16</span>                     <span class="c1">// NOTE: If you update health, be sure to update the ai_state_health property values below relative to new health</span>
<span class="lineno"> 17</span>         <span class="nx">maxVel</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">500</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">250</span><span class="p">},</span> <span class="c1">// NOTE: If you update maxVel, be sure to update the jump_height property values and speed values below relative to new maxVel</span>
<span class="lineno"> 18</span>         <span class="nx">speed</span><span class="o">:</span> <span class="mi">50</span><span class="p">,</span> <span class="c1">// Default horizontal movement speed; Default: 40</span>
<span class="lineno"> 19</span>                    <span class="c1">// NOTE: If you update speed, be sure to update the this.speed values below relative to new speed</span>
<span class="lineno"> 20</span>         <span class="nx">collide_damage</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// Default player damage when colliding with enemy; Default: 1</span>
<span class="lineno"> 21</span>         <span class="nx">damage_jump</span><span class="o">:</span> <span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="c1">// Default vertical player jump distance when colliding with enemy vertically; Default: -125</span>
<span class="lineno"> 22</span>         <span class="nx">damage_push</span><span class="o">:</span> <span class="mi">125</span><span class="p">,</span> <span class="c1">// Default horizontal player push distance when colliding with enemy horizontally; Default: 125</span>
<span class="lineno"> 23</span>         <span class="nx">kill_score</span><span class="o">:</span> <span class="mi">9001</span><span class="p">,</span> <span class="c1">// Just because it&#39;s a &quot;boss-type&quot; enemy :)</span>
<span class="lineno"> 24</span>         <span class="nx">maxHealth</span><span class="o">:</span> <span class="mi">45</span><span class="p">,</span>
<span class="lineno"> 25</span> 
<span class="lineno"> 26</span>         <span class="c1">// ----- Begin custom properties -----</span>
<span class="lineno"> 27</span>         <span class="c1">// Game/Level properties</span>
<span class="lineno"> 28</span>         <span class="nx">exit_when_killed</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// Exit level (and display stats screen) when enemy is killed</span>
<span class="lineno"> 29</span> 
<span class="lineno"> 30</span>         <span class="c1">// AI state properties</span>
<span class="lineno"> 31</span>         <span class="nx">grace_time</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="c1">// Grace (non-agression) time to allow player a chance to escape if enemy is camping player respawn zone on player death</span>
<span class="lineno"> 32</span>         <span class="nx">ai_state</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// 0 = default, 1 = annoyed, 2 = angry, 3 = rampage</span>
<span class="lineno"> 33</span>         <span class="nx">ai_state_health</span><span class="o">:</span> <span class="p">{</span><span class="nx">annoyed</span><span class="o">:</span> <span class="mi">35</span><span class="p">,</span> <span class="nx">angry</span><span class="o">:</span> <span class="mi">25</span><span class="p">,</span> <span class="nx">rampage</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">panick</span><span class="o">:</span> <span class="mi">15</span><span class="p">},</span> <span class="c1">// Health values at which the enemy&#39;s AI will switch</span>
<span class="lineno"> 34</span> 
<span class="lineno"> 35</span>         <span class="c1">// Detection properties</span>
<span class="lineno"> 36</span>         <span class="nx">icu_check_dist</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">65</span><span class="p">},</span> <span class="c1">// x, y distance enemy will detect player at</span>
<span class="lineno"> 37</span>         <span class="nx">icu_chase_dist</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">600</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">300</span><span class="p">},</span> <span class="c1">// x, y distance enemy will chase player at (span almost the entire map)</span>
<span class="lineno"> 38</span> 
<span class="lineno"> 39</span>         <span class="c1">// Attack projectile properties</span>
<span class="lineno"> 40</span>         <span class="nx">attack_damage</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="c1">// damage inflicted from attack projectiles if collide with player by default</span>
<span class="lineno"> 41</span>         <span class="nx">unreachable_damage</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="c1">// damage inflicted from attack projectiles if collide with player if player is unreachable</span>
<span class="lineno"> 42</span>         <span class="nx">projectile_speed</span><span class="o">:</span> <span class="mi">110</span><span class="p">,</span> <span class="c1">// Speed of attack projectile</span>
<span class="lineno"> 43</span>         <span class="nx">attack_spread</span><span class="o">:</span> <span class="p">{</span><span class="nx">base</span><span class="o">:</span> <span class="mi">60</span><span class="p">,</span> <span class="nx">delta</span><span class="o">:</span> <span class="mi">15</span><span class="p">},</span> <span class="c1">// base and variable y-component of projectile spread</span>
<span class="lineno"> 44</span>         <span class="nx">attack_interval</span><span class="o">:</span> <span class="p">{</span><span class="nx">min</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">max</span><span class="o">:</span> <span class="mi">4</span><span class="p">},</span> <span class="c1">// minimum and maximum range of seconds between attacks (generated randomly)</span>
<span class="lineno"> 45</span>         <span class="nx">attack_charge</span><span class="o">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="c1">// seconds between stopping/charging and launching attack projectile (used in conjuntion with animation speed)</span>
<span class="lineno"> 46</span> 
<span class="lineno"> 47</span>         <span class="c1">// Protection/Shell state properties</span>
<span class="lineno"> 48</span>         <span class="nx">shell_hide_time</span><span class="o">:</span> <span class="p">{</span><span class="nx">base</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">min</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">max</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span> <span class="c1">// seconds to hide in shell before returning to normal state</span>
<span class="lineno"> 49</span>         <span class="nx">shell_panick_attack_wait_time</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="c1">// seconds before enemy starts spewing attack projectiles while in panick state and in shell</span>
<span class="lineno"> 50</span> 
<span class="lineno"> 51</span>         <span class="c1">// Jump properties</span>
<span class="lineno"> 52</span>         <span class="nx">jump_interval</span><span class="o">:</span> <span class="p">{</span><span class="nx">min</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">max</span><span class="o">:</span> <span class="mi">4</span><span class="p">},</span> <span class="c1">// minimum and maximum range of seconds between jumping (generated randomly)</span>
<span class="lineno"> 53</span>         <span class="nx">jump_height</span><span class="o">:</span> <span class="p">{</span><span class="nx">min</span><span class="o">:</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="nx">max</span><span class="o">:</span> <span class="o">-</span><span class="mi">100</span><span class="p">},</span> <span class="c1">// minimum and maximum range of height in which to jump (generated randomly)</span>
<span class="lineno"> 54</span>         <span class="nx">unreachable_patience</span><span class="o">:</span> <span class="mi">15</span><span class="p">,</span> <span class="c1">// seconds at which enemy will wait until it suspects player is unreachable</span>
<span class="lineno"> 55</span>         <span class="c1">// ----- End custom properties -----</span>
<span class="lineno"> 56</span> 
<span class="lineno"> 57</span>         <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 58</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>
<span class="lineno"> 59</span> 
<span class="lineno"> 60</span>             <span class="c1">// Set up animation states</span>
<span class="lineno"> 61</span>             <span class="k">this</span><span class="p">.</span><span class="nx">addAnim</span><span class="p">(</span><span class="s1">&#39;idle&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">true</span><span class="p">);</span> <span class="c1">// Initial animation</span>
<span class="lineno"> 62</span>             <span class="k">this</span><span class="p">.</span><span class="nx">addAnim</span><span class="p">(</span><span class="s1">&#39;crawl&#39;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<span class="lineno"> 63</span>             <span class="k">this</span><span class="p">.</span><span class="nx">addAnim</span><span class="p">(</span><span class="s1">&#39;attack&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]);</span>
<span class="lineno"> 64</span>             <span class="k">this</span><span class="p">.</span><span class="nx">addAnim</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">]);</span>
<span class="lineno"> 65</span> 
<span class="lineno"> 66</span>             <span class="c1">// Correct idle animation flip</span>
<span class="lineno"> 67</span>             <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">idle</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno"> 68</span>             <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">attack</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno"> 69</span> 
<span class="lineno"> 70</span>             <span class="c1">// Timers</span>
<span class="lineno"> 71</span>             <span class="k">this</span><span class="p">.</span><span class="nx">shootTimer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Timer</span><span class="p">();</span>
<span class="lineno"> 72</span>             <span class="k">this</span><span class="p">.</span><span class="nx">shellTimer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Timer</span><span class="p">();</span>
<span class="lineno"> 73</span>             <span class="k">this</span><span class="p">.</span><span class="nx">jumpTimer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Timer</span><span class="p">();</span>
<span class="lineno"> 74</span>             <span class="k">this</span><span class="p">.</span><span class="nx">unreachableTimer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Timer</span><span class="p">();</span>
<span class="lineno"> 75</span>             <span class="k">this</span><span class="p">.</span><span class="nx">graceTimer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Timer</span><span class="p">();</span>
<span class="lineno"> 76</span> 
<span class="lineno"> 77</span>             <span class="c1">// Flags</span>
<span class="lineno"> 78</span>             <span class="nx">setAtkTime</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Is attack interval timer set?</span>
<span class="lineno"> 79</span>             <span class="nx">setJumpTime</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Is jump interval timer set?</span>
<span class="lineno"> 80</span>             <span class="nx">panick</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Is enemy in panick state?</span>
<span class="lineno"> 81</span>             <span class="nx">inShell</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Is enemy in shell state?</span>
<span class="lineno"> 82</span> 
<span class="lineno"> 83</span>             <span class="c1">// Comparason variables</span>
<span class="lineno"> 84</span>             <span class="nx">max_health</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">health</span><span class="p">;</span> <span class="c1">// Maximum health to check enemy&#39;s condition</span>
<span class="lineno"> 85</span>             <span class="nx">provoke_health</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">health</span><span class="p">;</span> <span class="c1">// Initial health to check if enemy has been provoked</span>
<span class="lineno"> 86</span> 
<span class="lineno"> 87</span>             <span class="c1">// Temporary variables</span>
<span class="lineno"> 88</span>             <span class="k">this</span><span class="p">.</span><span class="nx">graceTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">grace_time</span><span class="p">);</span>
<span class="lineno"> 89</span>             <span class="nx">speed_tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// Wait until enemy detects player via detection AI</span>
<span class="lineno"> 90</span>             <span class="nx">shell_hide_time_tmp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">shell_hide_time</span><span class="p">;</span> <span class="c1">// Used to allow hide time back to be reverted to default</span>
<span class="lineno"> 91</span>             <span class="nx">icu</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Has enemy detected player?</span>
<span class="lineno"> 92</span>         <span class="p">},</span> <span class="c1">// End init method</span>
<span class="lineno"> 93</span> 
<span class="lineno"> 94</span>         <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 95</span>             <span class="nx">my_player</span> <span class="o">=</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">getEntitiesByType</span><span class="p">(</span><span class="s1">&#39;EntityPlayer&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno"> 96</span> 
<span class="lineno"> 97</span>             <span class="c1">// Move forward in flip direction</span>
<span class="lineno"> 98</span>             <span class="kd">var</span> <span class="nx">xdir</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 99</span>             <span class="k">this</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">speed_tmp</span> <span class="o">*</span> <span class="nx">xdir</span><span class="p">;</span>
<span class="lineno">100</span> 
<span class="lineno">101</span>             <span class="c1">// Enter panick state if enemy&#39;s health is low</span>
<span class="lineno">102</span>             <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">health</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state_health</span><span class="p">.</span><span class="nx">panick</span><span class="p">)</span>
<span class="lineno">103</span>                 <span class="nx">panick</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">104</span> 
<span class="lineno">105</span>             <span class="c1">// Reset patience timer if player is within reachable height</span>
<span class="lineno">106</span>             <span class="k">if</span><span class="p">((</span><span class="nx">my_player</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">my_player</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">my_player</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">y</span><span class="p">))</span>
<span class="lineno">107</span>                 <span class="k">this</span><span class="p">.</span><span class="nx">unreachableTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">108</span> 
<span class="lineno">109</span>             <span class="c1">// Enemy is not angry or in rampage state, is chasing player but cannot reach player for a long time even after out-of-patience mode --&gt; Give up, reset patience timer and don&#39;t chase anymore</span>
<span class="lineno">110</span>             <span class="k">if</span><span class="p">(</span><span class="nx">icu</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">unreachableTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">()</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">unreachable_patience</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">health</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state_health</span><span class="p">.</span><span class="nx">angry</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">111</span>                 <span class="k">this</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">crawl</span><span class="p">;</span>
<span class="lineno">112</span>                 <span class="k">this</span><span class="p">.</span><span class="nx">unreachableTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">113</span>                 <span class="nx">icu</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">114</span>             <span class="p">}</span>
<span class="lineno">115</span> 
<span class="lineno">116</span>             <span class="c1">// Update properties for new AI state if health reaches certain amount</span>
<span class="lineno">117</span>             <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ai_state</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">118</span>                 <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">health</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state_health</span><span class="p">.</span><span class="nx">annoyed</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">health</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state_health</span><span class="p">.</span><span class="nx">angry</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">119</span>                     <span class="c1">// Annoyed state</span>
<span class="lineno">120</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">=</span> <span class="mi">65</span><span class="p">;</span> <span class="c1">// Increase movement speed</span>
<span class="lineno">121</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">shell_hide_time</span><span class="p">.</span><span class="nx">base</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// Increase shell state time</span>
<span class="lineno">122</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">shell_hide_time</span><span class="p">.</span><span class="nx">min</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// Increase shell state time</span>
<span class="lineno">123</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">shell_hide_time</span><span class="p">.</span><span class="nx">max</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// Increase shell state time</span>
<span class="lineno">124</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">attack_interval</span><span class="p">.</span><span class="nx">min</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">;</span> <span class="c1">// Decrease frequency of attacks</span>
<span class="lineno">125</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">attack_charge</span> <span class="o">=</span> <span class="mf">1.05</span><span class="p">;</span> <span class="c1">// 1.5x attack charge time to compensate for increased projectiles</span>
<span class="lineno">126</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">*</span> <span class="mf">1.846</span><span class="p">;</span> <span class="c1">// Increase projectile speed relative to movement (so player doesn&#39;t get trapped between fast enemy and slow projectile)</span>
<span class="lineno">127</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">ai_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">128</span>                 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">health</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state_health</span><span class="p">.</span><span class="nx">angry</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">health</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state_health</span><span class="p">.</span><span class="nx">rampage</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">129</span>                     <span class="c1">// Angry state</span>
<span class="lineno">130</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span> <span class="c1">// Increase movement speed</span>
<span class="lineno">131</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">shell_hide_time</span><span class="p">.</span><span class="nx">base</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Increase shell state time</span>
<span class="lineno">132</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">shell_hide_time</span><span class="p">.</span><span class="nx">min</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// Increase shell state time</span>
<span class="lineno">133</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">shell_hide_time</span><span class="p">.</span><span class="nx">max</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Increase shell state time</span>
<span class="lineno">134</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">attack_interval</span><span class="p">.</span><span class="nx">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// Decrease frequency of attacks</span>
<span class="lineno">135</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">attack_charge</span> <span class="o">=</span> <span class="mf">1.4</span><span class="p">;</span> <span class="c1">// 2x attack charge time to compensate for increased projectiles</span>
<span class="lineno">136</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">*</span> <span class="mf">1.625</span><span class="p">;</span> <span class="c1">// Increase projectile speed relative to movement (so player doesn&#39;t get trapped between fast enemy and slow projectile)</span>
<span class="lineno">137</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">ai_state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno">138</span>                 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">health</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state_health</span><span class="p">.</span><span class="nx">rampage</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">139</span>                     <span class="c1">// Rampage state</span>
<span class="lineno">140</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">=</span> <span class="mi">105</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">health</span><span class="p">;</span> <span class="c1">// Increase movement speed; speed up further as health decreases</span>
<span class="lineno">141</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">attack_interval</span><span class="p">.</span><span class="nx">min</span> <span class="o">=</span> <span class="mf">1.25</span><span class="p">;</span> <span class="c1">// Increase frequency of attacks</span>
<span class="lineno">142</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">attack_interval</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">;</span> <span class="c1">// Increase frequency of attacks</span>
<span class="lineno">143</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">attack_charge</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">;</span> <span class="c1">// Return to default attack charge time due to decreased projectiles</span>
<span class="lineno">144</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">jump_interval</span><span class="p">.</span><span class="nx">min</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">;</span> <span class="c1">// Increase frequency of jumping</span>
<span class="lineno">145</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">jump_interval</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="mf">3.5</span><span class="p">;</span> <span class="c1">// Increase frequency of jumping</span>
<span class="lineno">146</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">jump_height</span><span class="p">.</span><span class="nx">min</span> <span class="o">*=</span> <span class="mf">1.15</span><span class="p">;</span> <span class="c1">// Increase jump height</span>
<span class="lineno">147</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">jump_height</span><span class="p">.</span><span class="nx">max</span> <span class="o">*=</span> <span class="mf">1.15</span><span class="p">;</span> <span class="c1">// Increase jump height</span>
<span class="lineno">148</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">*</span> <span class="mf">1.555</span><span class="p">;</span> <span class="c1">// Increase projectile speed relative to movement (so player doesn&#39;t get trapped between fast enemy and slow projectile)</span>
<span class="lineno">149</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">ai_state</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="lineno">150</span>                 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ai_state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">151</span>                     <span class="c1">// Rampage state (update AI)</span>
<span class="lineno">152</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">=</span> <span class="mi">105</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">health</span><span class="p">;</span> <span class="c1">// Increase movement speed; speed up further as health decreases</span>
<span class="lineno">153</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">*</span> <span class="mf">1.555</span><span class="p">;</span> <span class="c1">// Increase projectile speed relative to movement (so player doesn&#39;t get trapped between fast enemy and slow projectile)</span>
<span class="lineno">154</span>                 <span class="p">}</span>
<span class="lineno">155</span>             <span class="p">}</span>
<span class="lineno">156</span> 
<span class="lineno">157</span>             <span class="c1">// Enemy not in shell state --&gt; Use default AI</span>
<span class="lineno">158</span>             <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">inShell</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">159</span>                 <span class="c1">// Randomize interval between jumps</span>
<span class="lineno">160</span>                 <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">setJumpTime</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">161</span>                     <span class="nx">jump_dur</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">randomRange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">jump_interval</span><span class="p">.</span><span class="nx">min</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">jump_interval</span><span class="p">.</span><span class="nx">max</span><span class="p">);</span>
<span class="lineno">162</span>                     <span class="nx">setJumpTime</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">163</span>                 <span class="c1">// Enemy is on the ground, is moving (not in attack animation), and jump interval duration has elapsed,</span>
<span class="lineno">164</span>                 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">standing</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">jumpTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">jump_dur</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">165</span>                     <span class="c1">// Player is not directly on top or below enemy (prevents auto-killing itself if enemy keeps jumping under player)</span>
<span class="lineno">166</span>                     <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">my_player</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">my_player</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span> <span class="o">||</span> <span class="nx">my_player</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">167</span>                         <span class="c1">// Jump at random height</span>
<span class="lineno">168</span>                         <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unreachable_patience</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">unreachableTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">())</span>
<span class="lineno">169</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">randomRange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">jump_height</span><span class="p">.</span><span class="nx">min</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">jump_height</span><span class="p">.</span><span class="nx">max</span><span class="p">);</span>
<span class="lineno">170</span>                         <span class="c1">// Player is too high above enemy for too long (assume player is camping on top of a ledge or across an obstacle)</span>
<span class="lineno">171</span>                         <span class="k">else</span>
<span class="lineno">172</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">randomRange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">jump_height</span><span class="p">.</span><span class="nx">min</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">jump_height</span><span class="p">.</span><span class="nx">max</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">);</span>
<span class="lineno">173</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">jumpTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">174</span>                     <span class="p">}</span>
<span class="lineno">175</span>                 <span class="p">}</span>
<span class="lineno">176</span> 
<span class="lineno">177</span>                 <span class="c1">// Is player alive?</span>
<span class="lineno">178</span>                 <span class="k">if</span><span class="p">(</span><span class="nx">my_player</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">grace_time</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">graceTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">())</span> <span class="p">{</span>
<span class="lineno">179</span>                     <span class="c1">// Get player&#39;s position</span>
<span class="lineno">180</span>                     <span class="kd">var</span> <span class="nx">target_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">181</span>                     <span class="kd">var</span> <span class="nx">target_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">182</span>                     <span class="nx">target_x</span> <span class="o">=</span> <span class="nx">my_player</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="lineno">183</span>                     <span class="nx">target_y</span> <span class="o">=</span> <span class="nx">my_player</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="lineno">184</span>                     <span class="kd">var</span> <span class="nx">distToPlayer_x</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">target_x</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
<span class="lineno">185</span>                     <span class="kd">var</span> <span class="nx">distToPlayer_y</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">target_y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
<span class="lineno">186</span> 
<span class="lineno">187</span>                     <span class="c1">// Player is within enemy&#39;s potential detection range but has not detected player yet **OR** Enemy is provoked from player attacking it from afar</span>
<span class="lineno">188</span>                     <span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="nx">icu</span> <span class="o">&amp;&amp;</span> <span class="nx">distToPlayer_x</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">icu_check_dist</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">distToPlayer_y</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">icu_check_dist</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">health</span> <span class="o">&lt;</span> <span class="nx">provoke_health</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">189</span>                         <span class="c1">// Player in enemy&#39;s line-of-sight --&gt; Begin chasing behavior</span>
<span class="lineno">190</span>                         <span class="k">if</span><span class="p">((</span><span class="nx">target_x</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">target_x</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">))</span> <span class="p">{</span>
<span class="lineno">191</span>                             <span class="c1">// Start moving and play walking animation</span>
<span class="lineno">192</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">crawl</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">193</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">attack</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">194</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">crawl</span><span class="p">;</span>
<span class="lineno">195</span>                             <span class="nx">speed_tmp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span><span class="p">;</span>
<span class="lineno">196</span>                             <span class="nx">icu</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">197</span> 
<span class="lineno">198</span>                             <span class="c1">// Enemy is provoked --&gt; start chasing player; do not need to check if provoked again</span>
<span class="lineno">199</span>                             <span class="nx">provoke_health</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="lineno">200</span> 
<span class="lineno">201</span>                             <span class="c1">// Reset shoot timer to prevent instant firing attack projectile when start chasing</span>
<span class="lineno">202</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">shootTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">203</span>                             <span class="nx">setAtkTime</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">204</span>                         <span class="p">}</span>
<span class="lineno">205</span>                     <span class="c1">// Enemy has detected player --&gt; Begin chasing behavior; Extend detection/chasing range</span>
<span class="lineno">206</span>                     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">icu</span> <span class="o">&amp;&amp;</span> <span class="nx">distToPlayer_x</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">icu_chase_dist</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">distToPlayer_y</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">icu_chase_dist</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">207</span>                         <span class="c1">// Player is behind enemy --&gt; Enemy faces player</span>
<span class="lineno">208</span>                         <span class="k">if</span><span class="p">((</span><span class="nx">target_x</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">target_x</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">))</span> <span class="p">{</span>
<span class="lineno">209</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">flip</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">210</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">crawl</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">211</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">attack</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">212</span>                         <span class="p">}</span>
<span class="lineno">213</span> 
<span class="lineno">214</span>                         <span class="c1">// Set attack interval time</span>
<span class="lineno">215</span>                         <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">setAtkTime</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">216</span>                             <span class="c1">// Randomize interval between attacks</span>
<span class="lineno">217</span>                             <span class="nx">atk_dur</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">randomRange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attack_interval</span><span class="p">.</span><span class="nx">min</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_interval</span><span class="p">.</span><span class="nx">max</span><span class="p">);</span>
<span class="lineno">218</span>                             <span class="nx">setAtkTime</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">219</span>                         <span class="c1">// Attack procedure</span>
<span class="lineno">220</span>                         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shootTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">atk_dur</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">221</span>                             <span class="c1">// Stop moving and play attack animation</span>
<span class="lineno">222</span>                             <span class="nx">speed_tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">223</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">attack</span><span class="p">;</span>
<span class="lineno">224</span> 
<span class="lineno">225</span>                             <span class="c1">// Attack interval duration has elapsed</span>
<span class="lineno">226</span>                             <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shootTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">atk_dur</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_charge</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">227</span>                                 <span class="c1">// Stage 0 AI: Player tries to be smart by camping above/below enemy...</span>
<span class="lineno">228</span>                                 <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unreachable_patience</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">unreachableTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">())</span> <span class="p">{</span>
<span class="lineno">229</span>                                     <span class="c1">// Fire projectile above enemy! :)</span>
<span class="lineno">230</span>                                     <span class="k">if</span><span class="p">(</span><span class="nx">my_player</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">my_player</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
<span class="lineno">231</span>                                         <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span><span class="nx">EntityRing</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="p">{</span><span class="nx">flip</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">,</span> <span class="nx">damage</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">unreachable_damage</span><span class="p">,</span> <span class="nx">speed</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span><span class="p">}});</span>
<span class="lineno">232</span>                                     <span class="c1">// Fire projectile below enemy! :)</span>
<span class="lineno">233</span>                                     <span class="k">else</span>
<span class="lineno">234</span>                                         <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span><span class="nx">EntityRing</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="p">{</span><span class="nx">flip</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">,</span> <span class="nx">damage</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">unreachable_damage</span><span class="p">,</span> <span class="nx">speed</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span><span class="p">}});</span>
<span class="lineno">235</span>                                 <span class="c1">// Stage 1 AI: Single frontal projectile</span>
<span class="lineno">236</span>                                 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">health</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state_health</span><span class="p">.</span><span class="nx">annoyed</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">237</span>                                     <span class="c1">// Fire projectile in front of enemy</span>
<span class="lineno">238</span>                                     <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span><span class="nx">EntityRing</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="p">{</span><span class="nx">flip</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">,</span> <span class="nx">damage</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_damage</span><span class="p">,</span> <span class="nx">speed</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">0</span><span class="p">}});</span>
<span class="lineno">239</span>                                 <span class="c1">// Stage 2 AI: Triple frontal projectiles with randomized spread</span>
<span class="lineno">240</span>                                 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">health</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state_health</span><span class="p">.</span><span class="nx">angry</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">241</span>                                     <span class="c1">// Fire 3 projectiles in front of enemy</span>
<span class="lineno">242</span>                                     <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span><span class="nx">EntityRing</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="p">{</span><span class="nx">flip</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">,</span> <span class="nx">damage</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_damage</span><span class="p">,</span> <span class="nx">speed</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">attack_spread</span><span class="p">.</span><span class="nx">delta</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_spread</span><span class="p">.</span><span class="nx">base</span><span class="p">}});</span>
<span class="lineno">243</span>                                     <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span><span class="nx">EntityRing</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="p">{</span><span class="nx">flip</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">,</span> <span class="nx">damage</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_damage</span><span class="p">,</span> <span class="nx">speed</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">0</span><span class="p">}});</span>
<span class="lineno">244</span>                                     <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span><span class="nx">EntityRing</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="p">{</span><span class="nx">flip</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">,</span> <span class="nx">damage</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_damage</span><span class="p">,</span> <span class="nx">speed</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_spread</span><span class="p">.</span><span class="nx">delta</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_spread</span><span class="p">.</span><span class="nx">base</span><span class="p">}});</span>
<span class="lineno">245</span>                                 <span class="c1">// Stage 3 AI: Circular projectiles</span>
<span class="lineno">246</span>                                 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">health</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">ai_state_health</span><span class="p">.</span><span class="nx">rampage</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">247</span>                                     <span class="c1">// Fire 8 projectiles around enemy</span>
<span class="lineno">248</span>                                     <span class="kd">var</span> <span class="nx">ring_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="lineno">249</span>                                     <span class="kd">var</span> <span class="nx">angle_delta</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="nx">ring_count</span><span class="p">;</span>
<span class="lineno">250</span>                                     <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ring_count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">251</span>                                         <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span><span class="nx">EntityRing</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="p">{</span><span class="nx">flip</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">,</span> <span class="nx">damage</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_damage</span><span class="p">,</span> <span class="nx">speed</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">i</span> <span class="o">*</span> <span class="nx">angle_delta</span><span class="p">),</span> <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">i</span> <span class="o">*</span> <span class="nx">angle_delta</span><span class="p">)}});</span>
<span class="lineno">252</span>                                     <span class="p">}</span>
<span class="lineno">253</span>                                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">254</span>                                     <span class="c1">// Fire projectile in direction of player</span>
<span class="lineno">255</span>                                     <span class="kd">var</span> <span class="nx">dist_x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">target_x</span><span class="p">;</span>
<span class="lineno">256</span>                                     <span class="kd">var</span> <span class="nx">dist_y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">target_y</span><span class="p">;</span>
<span class="lineno">257</span>                                     <span class="kd">var</span> <span class="nx">angle_delta</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">tan</span><span class="p">(</span><span class="nx">dist_y</span> <span class="o">/</span> <span class="nx">dist_x</span><span class="p">);</span>
<span class="lineno">258</span>                                     <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span><span class="nx">EntityRing</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="p">{</span><span class="nx">flip</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">,</span> <span class="nx">damage</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_damage</span><span class="p">,</span> <span class="nx">speed</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">angle_delta</span><span class="p">),</span> <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">angle_delta</span><span class="p">)}});</span>
<span class="lineno">259</span>                                 <span class="p">}</span>
<span class="lineno">260</span> 
<span class="lineno">261</span>                                 <span class="c1">// Reset timer and animation</span>
<span class="lineno">262</span>                                 <span class="k">this</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">crawl</span><span class="p">;</span>
<span class="lineno">263</span>                                 <span class="k">this</span><span class="p">.</span><span class="nx">shootTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">264</span>                                 <span class="nx">speed_tmp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span><span class="p">;</span>
<span class="lineno">265</span>                                 <span class="nx">setAtkTime</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">266</span>                             <span class="p">}</span>
<span class="lineno">267</span>                         <span class="p">}</span>
<span class="lineno">268</span>                     <span class="p">}</span>
<span class="lineno">269</span>                 <span class="p">}</span>
<span class="lineno">270</span>             <span class="c1">// Enemy is in shell state</span>
<span class="lineno">271</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">272</span>                 <span class="c1">// Stop moving and play shell animation</span>
<span class="lineno">273</span>                 <span class="k">this</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">shell</span><span class="p">;</span>
<span class="lineno">274</span>                 <span class="nx">speed_tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">275</span>                 <span class="nx">shell_hide_time_tmp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">shell_hide_time</span><span class="p">.</span><span class="nx">base</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">randomRange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shell_hide_time</span><span class="p">.</span><span class="nx">min</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">shell_hide_time</span><span class="p">.</span><span class="nx">max</span><span class="p">);</span>
<span class="lineno">276</span> 
<span class="lineno">277</span>                 <span class="c1">// Not in panick mode and shell duration exceeded **OR** in panick mode and player is out of range</span>
<span class="lineno">278</span>                 <span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="nx">panick</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">shellTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">shell_hide_time_tmp</span><span class="p">)</span> <span class="o">||</span>
<span class="lineno">279</span>                     <span class="p">(</span><span class="nx">panick</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">distanceTo</span><span class="p">(</span><span class="nx">my_player</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">icu_check_dist</span><span class="p">.</span><span class="nx">x</span><span class="p">))</span> <span class="p">{</span>
<span class="lineno">280</span>                         <span class="c1">// Reset and return to default state</span>
<span class="lineno">281</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">crawl</span><span class="p">;</span>
<span class="lineno">282</span>                         <span class="nx">inShell</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">283</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">shellTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">284</span>                         <span class="nx">speed_tmp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span><span class="p">;</span>
<span class="lineno">285</span> 
<span class="lineno">286</span>                         <span class="c1">// Reset attack timer to prevent instant attack afterwards</span>
<span class="lineno">287</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">shootTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">288</span>                         <span class="nx">setAtkTime</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">289</span>                 <span class="c1">// In panick mode and player is in range --&gt; Start shooting projectiles randomly</span>
<span class="lineno">290</span>                 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">panick</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">distanceTo</span><span class="p">(</span><span class="nx">my_player</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">icu_check_dist</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">291</span>                     <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">setAtkTime</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">292</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">shootTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">293</span>                         <span class="nx">setAtkTime</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">294</span>                     <span class="c1">// Frequency of shooting projectiles increases as enemy&#39;s health decreases</span>
<span class="lineno">295</span>                     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shootTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">health</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span> <span class="o">/</span> <span class="nx">max_health</span><span class="p">)</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">shell_panick_attack_wait_time</span><span class="p">))</span> <span class="p">{</span>
<span class="lineno">296</span>                         <span class="c1">// Shoot a single projectile in a random direction</span>
<span class="lineno">297</span>                         <span class="kd">var</span> <span class="nx">angle_delta</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">;</span>
<span class="lineno">298</span>                         <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span><span class="nx">EntityRing</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="p">{</span><span class="nx">flip</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">,</span> <span class="nx">damage</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attack_damage</span><span class="p">,</span> <span class="nx">speed</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">angle_delta</span><span class="p">),</span> <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">projectile_speed</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">angle_delta</span><span class="p">)}});</span>
<span class="lineno">299</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">shootTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">shell_panick_attack_wait_time</span><span class="p">);</span>
<span class="lineno">300</span>                     <span class="p">}</span>
<span class="lineno">301</span>                 <span class="p">}</span>
<span class="lineno">302</span>             <span class="p">}</span>
<span class="lineno">303</span> 
<span class="lineno">304</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span>
<span class="lineno">305</span>         <span class="p">},</span> <span class="c1">// End update method</span>
<span class="lineno">306</span> 
<span class="lineno">307</span>         <span class="nx">randomRange</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">min</span><span class="p">,</span> <span class="nx">max</span><span class="p">){</span>
<span class="lineno">308</span>             <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">max</span> <span class="o">-</span> <span class="nx">min</span><span class="p">)</span> <span class="o">+</span> <span class="nx">min</span><span class="p">;</span>
<span class="lineno">309</span>         <span class="p">},</span>
<span class="lineno">310</span> 
<span class="lineno">311</span>         <span class="c1">// Add on to Basic AI&#39;s collideWith method</span>
<span class="lineno">312</span>         <span class="nx">handleMovementTrace</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">313</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="lineno">314</span> 
<span class="lineno">315</span>             <span class="c1">// If the enemy collides with an obstacle and is chasing player, climb/jump over obstacle.</span>
<span class="lineno">316</span>             <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">collision</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
<span class="lineno">317</span>                 <span class="k">if</span><span class="p">(</span><span class="nx">icu</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">standing</span><span class="p">)</span>
<span class="lineno">318</span>                     <span class="k">this</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jump_height</span><span class="p">.</span><span class="nx">max</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">;</span>
<span class="lineno">319</span>         <span class="p">},</span> <span class="c1">// End handleMovementTrace method</span>
<span class="lineno">320</span> 
<span class="lineno">321</span>         <span class="c1">// Override Basic AI&#39;s collideWith method</span>
<span class="lineno">322</span>         <span class="nx">collideWith</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">,</span> <span class="nx">axis</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">323</span>             <span class="c1">// Only do something if colliding with the Player</span>
<span class="lineno">324</span>             <span class="k">if</span><span class="p">(</span><span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">EntityPlayer</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">325</span>                 <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">grace_time</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">graceTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">())</span> <span class="p">{</span>
<span class="lineno">326</span>                     <span class="c1">// Player falls on enemy</span>
<span class="lineno">327</span>                     <span class="k">if</span><span class="p">(</span><span class="nx">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">328</span>                         <span class="c1">// Enemy is not in shell state --&gt; Do damage to enemy and enter shell state</span>
<span class="lineno">329</span>                         <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">inShell</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">330</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">receiveDamage</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">other</span><span class="p">);</span>
<span class="lineno">331</span>                             <span class="nx">inShell</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="lineno">332</span>                             <span class="k">this</span><span class="p">.</span><span class="nx">shellTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">333</span>                         <span class="c1">// Enemy just entered shell state --&gt; Push player back but player takes no damage</span>
<span class="lineno">334</span>                         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shellTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">335</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">damage_jump</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">336</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">other</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">damage_push</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">:</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">damage_push</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">;</span>
<span class="lineno">337</span>                         <span class="c1">// Enemy is already in shell state --&gt; Push player back and player takes extra damage</span>
<span class="lineno">338</span>                         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">339</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">receiveDamage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collide_damage</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="lineno">340</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">damage_jump</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">341</span>                             <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">other</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">damage_push</span> <span class="o">*</span> <span class="mf">1.25</span> <span class="o">:</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">damage_push</span> <span class="o">*</span> <span class="mf">1.25</span><span class="p">;</span>
<span class="lineno">342</span>                         <span class="p">}</span>
<span class="lineno">343</span>                     <span class="c1">// Player collides with enemy horizontally --&gt; Push player back and do damage.</span>
<span class="lineno">344</span>                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">345</span>                         <span class="nx">other</span><span class="p">.</span><span class="nx">receiveDamage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collide_damage</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="lineno">346</span>                         <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">damage_push</span> <span class="o">:</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">damage_push</span><span class="p">;</span>
<span class="lineno">347</span>                     <span class="p">}</span>
<span class="lineno">348</span> 
<span class="lineno">349</span>                     <span class="c1">// Player is killed --&gt; Exit shell state and stop chasing</span>
<span class="lineno">350</span>                     <span class="k">if</span><span class="p">(</span><span class="nx">other</span><span class="p">.</span><span class="nx">health</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">351</span>                         <span class="c1">// Stop chasing, enable grace time</span>
<span class="lineno">352</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">unreachableTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">353</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">graceTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">354</span>                         <span class="nx">icu</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">355</span> 
<span class="lineno">356</span>                         <span class="c1">// Reset and return to default state</span>
<span class="lineno">357</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">currentAnim</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">crawl</span><span class="p">;</span>
<span class="lineno">358</span>                         <span class="nx">inShell</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">359</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">shellTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">360</span>                         <span class="nx">speed_tmp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span><span class="p">;</span>
<span class="lineno">361</span> 
<span class="lineno">362</span>                         <span class="c1">// Reset attack timer to prevent instant attack afterwards</span>
<span class="lineno">363</span>                         <span class="k">this</span><span class="p">.</span><span class="nx">shootTimer</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">364</span>                         <span class="nx">setAtkTime</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="lineno">365</span>                     <span class="p">}</span>
<span class="lineno">366</span>                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">367</span>                     <span class="kd">var</span> <span class="nx">sign_x</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">?</span> <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">368</span>                     <span class="kd">var</span> <span class="nx">sign_y</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">?</span> <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">369</span>                     <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">sign_x</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">damage_push</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno">370</span>                     <span class="nx">other</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">sign_y</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">damage_jump</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno">371</span>                 <span class="p">}</span>
<span class="lineno">372</span>             <span class="p">}</span>
<span class="lineno">373</span>         <span class="p">},</span> <span class="c1">// End collideWith method</span>
<span class="lineno">374</span> 
<span class="lineno">375</span>         <span class="c1">// Add on to Basic AI&#39;s kill method</span>
<span class="lineno">376</span>         <span class="nx">kill</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">377</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span>
<span class="lineno">378</span> 
<span class="lineno">379</span>             <span class="c1">// End level and display stats screen</span>
<span class="lineno">380</span>             <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">exit_when_killed</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">381</span>                 <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">toggleEnding</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="lineno">382</span>             <span class="p">}</span>
<span class="lineno">383</span>         <span class="p">},</span> <span class="c1">// End kill method</span>
<span class="lineno">384</span> 
<span class="lineno">385</span>         <span class="c1">// Add on to Basic AI&#39;s receiveDamage method</span>
<span class="lineno">386</span>         <span class="nx">receiveDamage</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">387</span>             <span class="c1">// If under grace period, negate incoming damage completely</span>
<span class="lineno">388</span>             <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">grace_time</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">graceTimer</span><span class="p">.</span><span class="nx">delta</span><span class="p">())</span>
<span class="lineno">389</span>                 <span class="nx">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">390</span>             <span class="c1">// If receiving damage due to non-player collision (assume hammer or fireball) --&gt; Nerf damage to 1</span>
<span class="lineno">391</span>             <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">EntityPlayer</span><span class="p">))</span>
<span class="lineno">392</span>                 <span class="nx">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">393</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">other</span><span class="p">);</span>
<span class="lineno">394</span>         <span class="p">}</span> <span class="c1">// End receiveDamage method</span>
<span class="lineno">395</span>     <span class="p">});</span> <span class="c1">// End EntityIggy_koopa</span>
<span class="lineno">396</span> 
<span class="lineno">397</span>     <span class="c1">// Iggy Koopa&#39;s Ring Attack Projectile</span>
<span class="lineno">398</span>     <span class="nx">EntityRing</span> <span class="o">=</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Entity</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
<span class="lineno">399</span>         <span class="c1">// Set up collision</span>
<span class="lineno">400</span>         <span class="nx">type</span><span class="o">:</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Entity</span><span class="p">.</span><span class="nx">TYPE</span><span class="p">.</span><span class="nx">NONE</span><span class="p">,</span>
<span class="lineno">401</span>         <span class="nx">checkAgainst</span><span class="o">:</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Entity</span><span class="p">.</span><span class="nx">TYPE</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span>
<span class="lineno">402</span>         <span class="nx">collides</span><span class="o">:</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">Entity</span><span class="p">.</span><span class="nx">COLLIDES</span><span class="p">.</span><span class="nx">PASSIVE</span><span class="p">,</span>
<span class="lineno">403</span> 
<span class="lineno">404</span>         <span class="c1">// Add animation and set collision</span>
<span class="lineno">405</span>         <span class="nx">animSheet</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">AnimationSheet</span><span class="p">(</span><span class="s1">&#39;media/enemies/attack.png&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
<span class="lineno">406</span>         <span class="nx">size</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">16</span><span class="p">},</span>
<span class="lineno">407</span> 
<span class="lineno">408</span>         <span class="c1">// Set speed</span>
<span class="lineno">409</span>         <span class="nx">maxVel</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">165</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">165</span><span class="p">},</span>
<span class="lineno">410</span>         <span class="nx">speed</span><span class="o">:</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span>
<span class="lineno">411</span>         <span class="nx">gravityFactor</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// Prevent gravity from altering projectile&#39;s trajectory</span>
<span class="lineno">412</span> 
<span class="lineno">413</span>         <span class="nx">damage</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// Set default damage for projectile</span>
<span class="lineno">414</span> 
<span class="lineno">415</span>         <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">416</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>
<span class="lineno">417</span> 
<span class="lineno">418</span>             <span class="c1">// Set up animation states</span>
<span class="lineno">419</span>             <span class="k">this</span><span class="p">.</span><span class="nx">addAnim</span><span class="p">(</span><span class="s1">&#39;idle&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="lineno">420</span> 
<span class="lineno">421</span>             <span class="c1">// Set initial direction and speed</span>
<span class="lineno">422</span>             <span class="kd">var</span> <span class="nx">xdir</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="lineno">423</span>             <span class="k">this</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">xdir</span><span class="p">;</span>
<span class="lineno">424</span>             <span class="k">this</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="lineno">425</span>             <span class="k">this</span><span class="p">.</span><span class="nx">anims</span><span class="p">.</span><span class="nx">idle</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flip</span><span class="p">;</span>
<span class="lineno">426</span> 
<span class="lineno">427</span>             <span class="c1">// Load player object if not in Weltmeister</span>
<span class="lineno">428</span>             <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">ig</span><span class="p">.</span><span class="nx">global</span><span class="p">.</span><span class="nx">wm</span><span class="p">)</span>
<span class="lineno">429</span>                 <span class="nx">my_player</span> <span class="o">=</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">getEntitiesByType</span><span class="p">(</span><span class="s1">&#39;EntityPlayer&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno">430</span>         <span class="p">},</span> <span class="c1">// End init method</span>
<span class="lineno">431</span> 
<span class="lineno">432</span>         <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">433</span>             <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">();</span>
<span class="lineno">434</span> 
<span class="lineno">435</span>             <span class="c1">// Clean up: Auto-kill this entity if too far from player to prevent having too many entities on screen</span>
<span class="lineno">436</span>             <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">distanceTo</span><span class="p">(</span><span class="nx">my_player</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">system</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
<span class="lineno">437</span>                 <span class="k">this</span><span class="p">.</span><span class="nx">kill</span><span class="p">();</span>
<span class="lineno">438</span>         <span class="p">},</span> <span class="c1">// End update method</span>
<span class="lineno">439</span> 
<span class="lineno">440</span>         <span class="nx">handleMovementTrace</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">441</span>             <span class="c1">// Override entity&#39;s collision against walls so it can pass through them.</span>
<span class="lineno">442</span>             <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">system</span><span class="p">.</span><span class="nx">tick</span><span class="p">;</span>
<span class="lineno">443</span>             <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">system</span><span class="p">.</span><span class="nx">tick</span><span class="p">;</span>
<span class="lineno">444</span>         <span class="p">},</span> <span class="c1">// End handleMovementTrace method</span>
<span class="lineno">445</span> 
<span class="lineno">446</span>         <span class="nx">check</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">447</span>             <span class="c1">// Damage player and destroy this entity</span>
<span class="lineno">448</span>             <span class="nx">other</span><span class="p">.</span><span class="nx">receiveDamage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">damage</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="lineno">449</span>             <span class="nx">my_player</span> <span class="o">=</span> <span class="nx">ig</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">getEntitiesByType</span><span class="p">(</span><span class="s1">&#39;EntityPlayer&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno">450</span>             <span class="k">this</span><span class="p">.</span><span class="nx">kill</span><span class="p">();</span>
<span class="lineno">451</span>         <span class="p">}</span> <span class="c1">// End check method</span>
<span class="lineno">452</span>     <span class="p">});</span> <span class="c1">// End EntityRing</span>
<span class="lineno">453</span> <span class="p">});</span> <span class="c1">// End .defines</span>
</code></pre></div>

<p>As seen above, <code>iggy_koopa.js</code> is a combination of all techniques learned while creating entities of varying AI for our game, while putting to use the OOP skills gained throughout this project. At its core, this boss gets more and more difficult as his Hit Points (HP) drops, increasing both his speed of movement and attacks, as well as using different attacks on the player. These attacks include:</p>

<ul>
  <li>Stalking the player and firing projectiles at a random angle</li>
  <li>Stalking the player, computing a projectile trajectory and firing</li>
  <li>A ‘burst’ attack of projectiles</li>
</ul>

<p>As a fun, extra touch: if the player beats <code>iggy_koopa</code> with 10 or more lives, they can go on to challenge an insanely difficulty level containing (with no midpoints!) with the finale being a painful but entertaining new boss room.</p>

<h4 id="challenges-and-experiences">Challenges and Experiences</h4>

<p>Overall, Super Mario World Koopa Krisis was a huge success. Along with my group, I gained a lot of experience with JavaScript and learned more of the advantages of Object Oriented Programming firsthand, along with becoming more familiar with the ImpactJS Game Engine. </p>

<p>The biggest challenges faced during this project revolved around transitioning between different game states (a main game and an overworld state), as well as working around the limitations of ImpactJS’s <code>sound</code> class. One big challenge I personally faced was leading a large group and being able to break down tasks to their most basic form, as well as giving primer lessons on the game engine and JavaScript. In the end, it was a great experience for me as a leader on a project and helped push me to write clean, efficient code for others to understand, while learning as much as possible to pass it on to my dedicated members. </p>

<p>In the end, our group stayed together and we decided to tackle a far more complex game, a remake of Fire Emblem - Blazing Sword from the Game Boy Advanced. To view the current progress of my new project, you may do so <a style="color:red" href="http://drksephy.github.io/2014/03/30/fireemblem.html">here.</a></p>


    </section>

</div>

        <footer>

                <img class="avatar" src="https://en.gravatar.com/userimage/39972947/394bc3bd457c88f378f080eee8c1edc9.jpg" alt="Me" />
                <p>New personal web page of David Leonard. Engineer, Programmer and Enthusiast.</p>
                <p><a href="http://github.com/DrkSephy">github</a> | <a href="http://bitbucket.org/DrkSephy">bitbucket</a> | <a href="https://www.linkedin.com/profile/view?id=199545939&trk=nav_responsive_tab_profile">linkedin</a></p>
                <p>
                    <small>©2014 David Leonard </small><br />
                    <small>Made with <a href="http://jekyllrb.com/">Jekyll</a> &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small>
                </p>
        </footer>
    </div>

    <body>
    
    <script src="/js/scale.fix.js"></script>
  </body>

</body>
</html>